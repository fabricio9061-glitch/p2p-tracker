<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Registro P2P</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí±</text></svg>">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f0f0ee;min-height:100vh}
        .container{max-width:1400px;margin:0 auto;padding:15px;padding-bottom:30px}
        .header{text-align:center;margin-bottom:20px;padding-top:10px;position:relative}
        .header h1{color:#1e293b;font-size:1.8em;margin-bottom:5px}
        .header p{color:#64748b;font-size:0.9em}
        .sync-status{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:20px;font-size:0.75em;margin-top:8px}
        .sync-status.online{background:#dcfce7;color:#16a34a}
        .sync-status.offline{background:#fee2e2;color:#dc2626}
        .sync-status.syncing{background:#fef3c7;color:#d97706}
        .sync-dot{width:6px;height:6px;border-radius:50%;background:currentColor}
        .menu-container{position:absolute;top:10px;right:0}
        .menu-btn{background:white;border:1px solid #e2e8f0;border-radius:10px;padding:10px 12px;cursor:pointer;display:flex;flex-direction:column;gap:4px}
        .menu-btn span{display:block;width:20px;height:2px;background:#475569;border-radius:2px;transition:all 0.3s}
        .menu-btn.active span:nth-child(1){transform:rotate(45deg) translate(4px,4px)}
        .menu-btn.active span:nth-child(2){opacity:0}
        .menu-btn.active span:nth-child(3){transform:rotate(-45deg) translate(4px,-4px)}
        .menu-dropdown{position:absolute;top:50px;right:0;background:white;border:1px solid #e2e8f0;border-radius:12px;padding:8px;min-width:200px;box-shadow:0 10px 40px rgba(0,0,0,0.15);opacity:0;visibility:hidden;transform:translateY(-10px);transition:all 0.2s;z-index:1000}
        .menu-dropdown.active{opacity:1;visibility:visible;transform:translateY(0)}
        .menu-item{display:flex;align-items:center;gap:10px;padding:11px 12px;border-radius:8px;cursor:pointer;color:#1e293b;font-size:0.88em;font-weight:500}
        .menu-item:active{background:#f1f5f9}
        .menu-item.danger{color:#dc2626}
        .menu-divider{height:1px;background:#e2e8f0;margin:6px 0}
        .menu-user{padding:10px 12px;border-bottom:1px solid #e2e8f0;margin-bottom:6px}
        .menu-user-name{font-weight:600;color:#1e293b;font-size:0.9em}
        .menu-user-email{color:#64748b;font-size:0.7em;margin-top:2px}
        .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px}
        .card{background:white;border:1px solid #e2e8f0;border-radius:10px;padding:12px}
        .card.main-card{grid-column:span 2;background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%);border:2px solid #16a34a}
        .card.main-card.negative{background:linear-gradient(135deg,#fef2f2 0%,#fee2e2 100%);border-color:#dc2626}
        .card-title{color:#64748b;font-size:0.7em;font-weight:600;text-transform:uppercase;margin-bottom:4px}
        .card-value{font-size:1.4em;font-weight:bold}
        .card-subtitle{color:#94a3b8;font-size:0.65em;margin-top:2px}
        .positive{color:#16a34a}.negative{color:#dc2626}.info{color:#0284c7}
        .stats-row{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
        .stat-badge{font-size:0.6em;background:#f1f5f9;padding:2px 6px;border-radius:4px;color:#64748b}
        .section-title{color:#1e293b;font-size:1em;font-weight:600;margin-bottom:12px}
        .bancos-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:20px}
        .banco-mini-card{background:white;border:1px solid #e2e8f0;border-radius:8px;padding:10px;cursor:pointer}
        .banco-nombre{font-weight:600;color:#1e293b;font-size:0.8em;margin-bottom:2px}
        .banco-saldo{font-size:1.1em;font-weight:bold;color:#16a34a}
        .banco-moneda{font-size:0.65em;color:#94a3b8}
        .banco-limite{font-size:0.6em;color:#64748b;margin-top:2px}
        .banco-limite-bar{height:4px;background:#e2e8f0;border-radius:2px;margin-top:3px;overflow:hidden}
        .banco-limite-fill{height:100%;background:#3b82f6;border-radius:2px;transition:width 0.3s}
        .banco-limite-fill.warning{background:#f59e0b}
        .banco-limite-fill.danger{background:#dc2626}
        .usdt-card{background:linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%);border-color:#93c5fd}
        .usdt-card .banco-saldo{color:#2563eb}
        .toggle-section{background:white;border:1px solid #e2e8f0;border-radius:10px;margin-bottom:15px;overflow:hidden}
        .toggle-header{display:flex;justify-content:space-between;align-items:center;padding:14px 15px;cursor:pointer;user-select:none}
        .toggle-header:active{background:#f8fafc}
        .toggle-title{font-size:0.95em;font-weight:600;color:#1e293b;display:flex;align-items:center;gap:8px}
        .toggle-right{display:flex;align-items:center;gap:10px}
        .toggle-badge{background:#e2e8f0;color:#64748b;font-size:0.75em;padding:2px 8px;border-radius:10px;font-weight:500}
        .toggle-arrow{font-size:0.8em;color:#94a3b8;transition:transform 0.2s}
        .toggle-section.open .toggle-arrow{transform:rotate(180deg)}
        .toggle-content{display:none;border-top:1px solid #e2e8f0}
        .toggle-section.open .toggle-content{display:block}
        .form-content{padding:15px}
        .form-group{margin-bottom:12px}
        .form-group label{display:block;color:#64748b;font-size:0.75em;margin-bottom:4px;font-weight:500}
        .form-group input,.form-group select,.form-group textarea{width:100%;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;color:#1e293b;font-size:16px;font-family:inherit}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:#2563eb}
        .form-group input.error,.form-group select.error{border-color:#dc2626;background:#fef2f2}
        .form-group small{display:block;color:#94a3b8;font-size:0.7em;margin-top:3px}
        .form-group small.error-text{color:#dc2626}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .btn{background:#2563eb;color:white;border:none;padding:14px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-size:0.95em;width:100%}
        .btn:active{background:#1d4ed8}
        .btn:disabled{background:#94a3b8;cursor:not-allowed}
        .btn-delete{background:transparent;color:#ef4444;border:none;cursor:pointer;font-size:1.1em;padding:4px 8px}
        .info-text{color:#64748b;font-size:0.75em;margin-top:10px}
        .preview-box{background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:10px;margin-bottom:12px;color:#1e40af;font-size:0.85em}
        .table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
        table{width:100%;border-collapse:collapse;min-width:500px}
        th{background:#f8fafc;color:#64748b;font-size:0.68em;font-weight:600;padding:10px 8px;text-align:left;text-transform:uppercase}
        td{padding:10px 8px;color:#1e293b;border-top:1px solid #f1f5f9;font-size:0.8em}
        .badge{display:inline-block;padding:3px 8px;border-radius:12px;font-size:0.68em;font-weight:700}
        .badge-compra{background:#dcfce7;color:#16a34a}
        .badge-venta{background:#fee2e2;color:#dc2626}
        .badge-ingreso{background:#dcfce7;color:#16a34a}
        .badge-egreso{background:#fee2e2;color:#dc2626}
        .text-compra,.text-ingreso{color:#16a34a;font-weight:700}
        .text-venta,.text-egreso{color:#dc2626;font-weight:700}
        .empty-state{text-align:center;padding:30px;color:#94a3b8}
        .empty-state-icon{font-size:2em;margin-bottom:8px}
        .pagination{display:flex;justify-content:center;align-items:center;gap:8px;padding:12px;border-top:1px solid #e2e8f0}
        .pagination button{background:#f1f5f9;border:none;padding:8px 14px;border-radius:6px;font-size:0.85em;cursor:pointer;color:#475569}
        .pagination button:disabled{opacity:0.4;cursor:not-allowed}
        .pagination-info{font-size:0.8em;color:#64748b}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;padding:15px}
        .modal.active{display:flex}
        .modal-content{background:white;border-radius:14px;padding:20px;max-width:420px;width:100%;max-height:85vh;overflow-y:auto}
        .modal-header{font-size:1.2em;font-weight:bold;color:#1e293b;margin-bottom:15px}
        .modal-buttons{display:flex;gap:10px;margin-top:18px}
        .modal-buttons .btn{flex:1}
        .btn-cancel{background:#e5e7eb;color:#4b5563}
        .banco-list-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:8px;background:#f8fafc}
        .banco-list-actions{display:flex;gap:8px;align-items:center}
        .toggle-switch{position:relative;width:44px;height:24px}
        .toggle-switch input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#cbd5e1;transition:.3s;border-radius:24px}
        .toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.3s;border-radius:50%}
        .toggle-switch input:checked+.toggle-slider{background-color:#16a34a}
        .toggle-switch input:checked+.toggle-slider:before{transform:translateX(20px)}
        .btn-edit-small{padding:5px 10px;font-size:0.7em;background:#3b82f6;color:white;border:none;border-radius:5px}
        .tabs{display:flex;gap:5px;margin-bottom:12px}
        .tab{padding:8px 14px;border-radius:8px;cursor:pointer;font-size:0.85em;font-weight:500;background:#f1f5f9;color:#64748b;border:none;flex:1;text-align:center}
        .tab.active.tab-ingreso{background:#16a34a;color:white}
        .tab.active.tab-egreso{background:#dc2626;color:white}
        .tab.active{background:#2563eb;color:white}
        .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.95);display:flex;align-items:center;justify-content:center;z-index:2000;flex-direction:column;gap:12px}
        .loading-overlay.hidden{display:none}
        .spinner{width:36px;height:36px;border:3px solid #e2e8f0;border-top-color:#2563eb;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .auth-container{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
        .auth-box{background:white;border-radius:16px;padding:30px 20px;max-width:360px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.1)}
        .auth-logo{text-align:center;font-size:2.5em;margin-bottom:8px}
        .auth-title{text-align:center;color:#1e293b;font-size:1.3em;margin-bottom:6px}
        .auth-subtitle{text-align:center;color:#64748b;font-size:0.85em;margin-bottom:25px}
        .auth-tabs{display:flex;margin-bottom:20px;border-radius:10px;background:#f1f5f9;padding:4px}
        .auth-tab{flex:1;padding:10px;text-align:center;border-radius:8px;cursor:pointer;font-weight:500;color:#64748b;border:none;background:transparent;font-size:0.9em}
        .auth-tab.active{background:white;color:#1e293b;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
        .auth-error{background:#fee2e2;color:#dc2626;padding:10px;border-radius:8px;margin-bottom:14px;font-size:0.85em;display:none}
        .auth-error.show{display:block}
        .app-container{display:none}
        .app-container.active{display:block}
        .auth-container.hidden{display:none}
        .calendar-container{background:#1a1a2e;border-radius:12px;padding:15px}
        .calendar-header{display:flex;justify-content:center;align-items:center;gap:15px;margin-bottom:15px}
        .calendar-header button{background:none;border:none;color:white;font-size:1.2em;cursor:pointer;padding:5px 10px}
        .calendar-month{color:white;font-size:1.1em;font-weight:600;min-width:100px;text-align:center}
        .calendar-weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:8px}
        .calendar-weekday{color:#64748b;font-size:0.7em;text-align:center;font-weight:600}
        .calendar-days{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
        .calendar-day{aspect-ratio:1;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:0.8em;color:white;background:#2d2d44;min-height:42px}
        .calendar-day.empty{background:transparent}
        .calendar-day.positive{background:linear-gradient(135deg,#064e3b 0%,#065f46 100%)}
        .calendar-day.negative{background:linear-gradient(135deg,#7f1d1d 0%,#991b1b 100%)}
        .calendar-day.today{box-shadow:0 0 0 2px #3b82f6}
        .calendar-day-number{font-weight:600;font-size:0.95em}
        .calendar-day-value{font-size:0.6em;margin-top:1px}
        .calendar-day-value.pos{color:#4ade80}
        .calendar-day-value.neg{color:#f87171}
        .calendar-summary{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:12px}
        .calendar-stat{background:#2d2d44;border-radius:8px;padding:10px;text-align:center}
        .calendar-stat.full{grid-column:span 2}
        .calendar-stat-value{color:white;font-size:1.1em;font-weight:bold}
        .calendar-stat-label{color:#64748b;font-size:0.65em;margin-top:2px}
        .comision-inline{display:flex;align-items:center;gap:6px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:8px 12px;margin-top:8px}
        .comision-inline label{color:#64748b;font-size:0.75em;font-weight:500;white-space:nowrap}
        .comision-inline input{width:60px;background:white;border:1px solid #e2e8f0;border-radius:6px;padding:8px;color:#1e293b;font-size:16px;text-align:center}
        .comision-inline input:focus{outline:none;border-color:#2563eb}
        .comision-inline span{color:#64748b;font-weight:500}
        .cooldown-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);z-index:1500;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px}
        .cooldown-overlay.hidden{display:none}
        .cooldown-text{color:#1e293b;font-weight:600;font-size:1.1em}
        @media(min-width:640px){.cards{grid-template-columns:repeat(3,1fr)}.card.main-card{grid-column:span 1}.bancos-grid{grid-template-columns:repeat(3,1fr)}}
        @media(min-width:1024px){.cards{grid-template-columns:repeat(6,1fr)}.bancos-grid{grid-template-columns:repeat(6,1fr)}}
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div><div style="color:#64748b;font-size:0.9em">Cargando...</div></div>
    <div class="cooldown-overlay hidden" id="cooldownOverlay"><div class="spinner"></div><div class="cooldown-text">Guardado ‚úì</div></div>
    
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-logo">üí±</div>
            <h1 class="auth-title">Registro P2P</h1>
            <p class="auth-subtitle">Control de operaciones y saldos</p>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')" id="tabLogin">Iniciar Sesi√≥n</button>
                <button class="auth-tab" onclick="switchAuthTab('register')" id="tabRegister">Registrarse</button>
            </div>
            <div class="auth-error" id="authError"></div>
            <form class="auth-form" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group"><label>Usuario</label><input type="text" id="loginUser" placeholder="Tu usuario" required></div>
                <div class="form-group"><label>Contrase√±a</label><input type="password" id="loginPass" placeholder="Tu contrase√±a" required></div>
                <button type="submit" class="btn" id="loginBtn">Iniciar Sesi√≥n</button>
            </form>
            <form class="auth-form" id="registerForm" style="display:none" onsubmit="handleRegister(event)">
                <div class="form-group"><label>Usuario</label><input type="text" id="regUser" placeholder="Elige un usuario" required><small>Letras, n√∫meros, guiones. 3-20 caracteres.</small></div>
                <div class="form-group"><label>Contrase√±a</label><input type="password" id="regPass" placeholder="Crea una contrase√±a" required><small>M√≠nimo 6 caracteres</small></div>
                <div class="form-group"><label>Confirmar Contrase√±a</label><input type="password" id="regPassConfirm" placeholder="Repite la contrase√±a" required></div>
                <button type="submit" class="btn" id="registerBtn">Crear Cuenta</button>
            </form>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="container">
            <div class="header">
                <h1>üí± Registro P2P</h1>
                <p>Control de operaciones y saldos</p>
                <div class="sync-status offline" id="syncStatus"><div class="sync-dot"></div><span id="syncText">...</span></div>
                <div class="menu-container">
                    <button class="menu-btn" onclick="toggleMenu()" id="menuBtn"><span></span><span></span><span></span></button>
                    <div class="menu-dropdown" id="menuDropdown">
                        <div class="menu-user"><div class="menu-user-name" id="menuUserName">Usuario</div><div class="menu-user-email" id="menuUserEmail">@p2p</div></div>
                        <div class="menu-item" onclick="abrirCalendario();cerrarMenu()"><span>üìÖ</span><span>Calendario</span></div>
                        <div class="menu-item" onclick="abrirModalMovimiento();cerrarMenu()"><span>üí∏</span><span>Movimiento Externo</span></div>
                        <div class="menu-item" onclick="abrirModalBancos();cerrarMenu()"><span>üè¶</span><span>Gestionar Bancos</span></div>
                        <div class="menu-item" onclick="abrirModalTransferencia();cerrarMenu()"><span>‚ÜîÔ∏è</span><span>Transferencia</span></div>
                        <div class="menu-divider"></div>
                        <div class="menu-item" onclick="exportarDatos();cerrarMenu()"><span>üì§</span><span>Exportar</span></div>
                        <div class="menu-item" onclick="document.getElementById('importFile').click();cerrarMenu()"><span>üì•</span><span>Importar</span></div>
                        <div class="menu-divider"></div>
                        <div class="menu-item danger" onclick="borrarTodo();cerrarMenu()"><span>üóëÔ∏è</span><span>Borrar Todo</span></div>
                        <div class="menu-divider"></div>
                        <div class="menu-item" onclick="cerrarSesion();cerrarMenu()"><span>üö™</span><span>Cerrar Sesi√≥n</span></div>
                    </div>
                </div>
                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importarDatos(event)">
            </div>
            
            <div class="cards">
                <div class="card main-card" id="cardGananciaHoy"><div class="card-title">üìà Ganancia Hoy</div><div class="card-value positive" id="gananciaHoy">$0</div><div class="card-subtitle" id="fechaHoy">--</div><div class="stats-row"><span class="stat-badge" id="opsHoy">0 ops</span></div></div>
                <div class="card"><div class="card-title">üì¶ USDT</div><div class="card-value info" id="usdtEnTenencia">0,00</div><div class="card-subtitle">En tenencia</div></div>
                <div class="card"><div class="card-title">üè¶ Bancos</div><div class="card-value positive" id="totalBancos">$0</div><div class="card-subtitle">Saldo UYU</div></div>
                <div class="card"><div class="card-title">üì• <span class="text-compra">Compras</span></div><div class="card-value" style="font-size:1.2em" id="totalPagado">$0</div><div class="stats-row"><span class="stat-badge" id="tasaPromCompra">--</span></div></div>
                <div class="card"><div class="card-title">üì§ <span class="text-venta">Ventas</span></div><div class="card-value" style="font-size:1.2em" id="totalRecibido">$0</div><div class="stats-row"><span class="stat-badge" id="tasaPromVenta">--</span></div></div>
                <div class="card"><div class="card-title">üìä Spread</div><div class="card-value info" id="spreadPromedio">$0</div><div class="stats-row"><span class="stat-badge" id="porcentajeSpread">0%</span></div></div>
            </div>
            
            <div class="section-title">üíº Mis Saldos</div>
            <div class="bancos-grid" id="bancosGrid"></div>

            <!-- NUEVA OPERACI√ìN -->
            <div class="toggle-section open" id="seccionNuevaOp">
                <div class="toggle-header" onclick="toggleSeccion('seccionNuevaOp')">
                    <span class="toggle-title">‚ûï Nueva Operaci√≥n</span>
                    <span class="toggle-arrow">‚ñº</span>
                </div>
                <div class="toggle-content">
                    <div class="form-content">
                        <div class="form-group">
                            <label>Tipo de operaci√≥n</label>
                            <select id="tipo" onchange="actualizarFormulario()">
                                <option value="compra">üõí Compra USDT</option>
                                <option value="venta">üíµ Venta USDT</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label id="montoLabel">Monto (UYU)</label>
                                <input type="number" step="0.01" id="monto" placeholder="3900" oninput="calcularPreview()">
                            </div>
                            <div class="form-group">
                                <label>Tasa *</label>
                                <input type="text" id="tasa" placeholder="39.50" oninput="calcularPreview()" inputmode="decimal">
                                <small id="tasaHelp">Ej: 39.50</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label id="bancoLabel">Banco *</label>
                                <select id="banco" onchange="mostrarSaldoBanco()">
                                    <option value="">-- Seleccionar --</option>
                                </select>
                                <small id="bancoHelp"></small>
                            </div>
                            <div class="form-group" id="comisionBancoGroup">
                                <label>Comisi√≥n banco</label>
                                <input type="number" step="0.01" id="comisionBanco" value="0" placeholder="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" id="fecha">
                        </div>
                        <div class="comision-inline">
                            <label>üìä Comisi√≥n Binance:</label>
                            <input type="text" id="comisionPlataforma" value="0.14" placeholder="0.14" inputmode="decimal" oninput="guardarComisionYCalcular()">
                            <span>%</span>
                        </div>
                        <div class="preview-box" id="previewBox" style="display:none"><span id="previewText"></span></div>
                        <button class="btn" id="btnAgregarOp" onclick="agregarOperacion()" style="margin-top:12px">Agregar Operaci√≥n</button>
                        <div class="info-text">Comisi√≥n <span id="comisionPctLabel">0.14</span>%: <strong id="comisionPlataformaInfo">0 USDT</strong> <span id="saldoBancoInfo"></span></div>
                    </div>
                </div>
            </div>

            <!-- OPERACIONES -->
            <div class="toggle-section open" id="seccionOperaciones">
                <div class="toggle-header" onclick="toggleSeccion('seccionOperaciones')">
                    <span class="toggle-title">üìã Operaciones</span>
                    <div class="toggle-right">
                        <span class="toggle-badge" id="totalOperaciones">0</span>
                        <span class="toggle-arrow">‚ñº</span>
                    </div>
                </div>
                <div class="toggle-content">
                    <div class="table-scroll" id="tablaContent">
                        <div class="empty-state"><div class="empty-state-icon">üìù</div><div>Sin operaciones</div></div>
                    </div>
                    <div class="pagination" id="paginationOp" style="display:none">
                        <button onclick="cambiarPagina(-1)" id="btnPrevOp">‚Üê Ant</button>
                        <span class="pagination-info" id="paginaInfoOp">1 / 1</span>
                        <button onclick="cambiarPagina(1)" id="btnNextOp">Sig ‚Üí</button>
                    </div>
                </div>
            </div>

            <!-- MOVIMIENTOS -->
            <div class="toggle-section" id="seccionMovimientos" style="display:none">
                <div class="toggle-header" onclick="toggleSeccion('seccionMovimientos')">
                    <span class="toggle-title">üí∏ Movimientos</span>
                    <div class="toggle-right">
                        <span class="toggle-badge" id="totalMovimientos">0</span>
                        <span class="toggle-arrow">‚ñº</span>
                    </div>
                </div>
                <div class="toggle-content">
                    <div class="table-scroll" id="movimientosContent"></div>
                </div>
            </div>

            <!-- TRANSFERENCIAS -->
            <div class="toggle-section" id="seccionTransferencias" style="display:none">
                <div class="toggle-header" onclick="toggleSeccion('seccionTransferencias')">
                    <span class="toggle-title">‚ÜîÔ∏è Transferencias</span>
                    <div class="toggle-right">
                        <span class="toggle-badge" id="totalTransferencias">0</span>
                        <span class="toggle-arrow">‚ñº</span>
                    </div>
                </div>
                <div class="toggle-content">
                    <div class="table-scroll" id="transferenciasContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modalCalendario" class="modal"><div class="modal-content" style="max-width:420px;padding:15px"><div class="calendar-container"><div class="calendar-header"><button onclick="cambiarMes(-1)">‚óÄ</button><div class="calendar-month" id="calendarMonth">2025-01</div><button onclick="cambiarMes(1)">‚ñ∂</button></div><div class="calendar-weekdays"><div class="calendar-weekday">D</div><div class="calendar-weekday">L</div><div class="calendar-weekday">M</div><div class="calendar-weekday">M</div><div class="calendar-weekday">J</div><div class="calendar-weekday">V</div><div class="calendar-weekday">S</div></div><div class="calendar-days" id="calendarDays"></div><div class="calendar-summary"><div class="calendar-stat full" id="calGananciaTotalBox"><div class="calendar-stat-value positive" id="calGananciaTotal">$0</div><div class="calendar-stat-label">üí∞ Ganancia Total</div></div><div class="calendar-stat"><div class="calendar-stat-value positive" id="calGanancias">$0</div><div class="calendar-stat-label">Mes +</div></div><div class="calendar-stat"><div class="calendar-stat-value negative" id="calPerdidas">$0</div><div class="calendar-stat-label">Mes -</div></div></div></div><div class="modal-buttons"><button class="btn" onclick="cerrarCalendario()">Cerrar</button></div></div></div>
    <div id="modalMovimiento" class="modal"><div class="modal-content"><div class="modal-header">üí∏ Movimiento Externo</div><div class="tabs"><button class="tab tab-ingreso active" onclick="setTipoMovimiento('ingreso')" id="tabIngreso">üì• <span class="text-compra">Ingreso</span></button><button class="tab tab-egreso" onclick="setTipoMovimiento('egreso')" id="tabEgreso">üì§ <span class="text-venta">Egreso</span></button></div><div class="form-group"><label>Tipo de cuenta</label><select id="movTipoCuenta" onchange="actualizarCuentasMovimiento()"><option value="banco">üè¶ Banco</option><option value="usdt">ü™ô USDT</option></select></div><div class="form-group" id="movBancoGroup"><label>Banco</label><select id="movBanco"></select></div><div class="form-group"><label id="movMontoLabel">Monto</label><input type="number" step="0.01" id="movMonto"></div><div class="form-group"><label>Descripci√≥n (opcional)</label><textarea id="movDescripcion" rows="2"></textarea></div><div class="form-group"><label>Fecha</label><input type="date" id="movFecha"></div><div class="modal-buttons"><button class="btn btn-cancel" onclick="cerrarModalMovimiento()">Cancelar</button><button class="btn" id="btnGuardarMov" onclick="guardarMovimiento()">Guardar</button></div></div></div>
    <div id="modalBancos" class="modal"><div class="modal-content"><div class="modal-header">üè¶ Gestionar Bancos</div><div id="listaBancos"></div><div class="modal-buttons"><button class="btn" onclick="cerrarModalBancos()">Cerrar</button></div></div></div>
    <div id="modalTransferencia" class="modal"><div class="modal-content"><div class="modal-header">‚ÜîÔ∏è Transferencia entre Bancos</div><div class="form-group"><label>Banco origen</label><select id="bancoOrigen" onchange="mostrarSaldoOrigen()"></select><small id="saldoOrigenInfo"></small></div><div class="form-group"><label>Banco destino</label><select id="bancoDestino"></select></div><div class="form-group"><label>Monto</label><input type="number" step="0.01" id="montoTransferencia"></div><div class="form-group"><label>Comisi√≥n (opcional)</label><input type="number" step="0.01" id="comisionTransferencia" value="0"></div><div class="form-group"><label>Fecha</label><input type="date" id="fechaTransferencia"></div><div class="modal-buttons"><button class="btn btn-cancel" onclick="cerrarModalTransferencia()">Cancelar</button><button class="btn" id="btnTransferir" onclick="realizarTransferencia()">Transferir</button></div></div></div>
    <div id="modalEditarSaldo" class="modal"><div class="modal-content"><div class="modal-header" id="editarSaldoHeader">Editar Saldo</div><div class="form-group"><label>Nuevo saldo</label><input type="number" step="0.01" id="nuevoSaldoBanco"></div><div class="form-group" id="limiteDiarioGroup"><label>L√≠mite diario de transferencia</label><input type="number" step="1" id="limiteDiarioBanco" placeholder="0 = sin l√≠mite"></div><div class="modal-buttons"><button class="btn btn-cancel" onclick="cerrarModalEditarSaldo()">Cancelar</button><button class="btn" onclick="guardarNuevoSaldo()">Guardar</button></div></div></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
const firebaseConfig={apiKey:"AIzaSyCL2uxQMNIxC0oo35uN-lYQXaOWLxXNg7k",authDomain:"p2p-tracker-dc9cc.firebaseapp.com",projectId:"p2p-tracker-dc9cc",storageBucket:"p2p-tracker-dc9cc.firebasestorage.app",messagingSenderId:"670856094446",appId:"1:670856094446:web:390946887212a97e36c9ff"};
let db=null,auth=null,currentUser=null,unsubscribe=null;
let datos={operaciones:[],movimientos:[],transferencias:[],bancos:{},saldoUsdt:0,ultimaTasaCompra:0,ultimaTasaVenta:0,comisionPlataforma:0.14};
let bancoEditando=null,tipoMovimiento='ingreso',calendarDate=new Date(),paginaActual=1;
let guardandoMovimiento=false,enCooldown=false;
const POR_PAGINA=10,EMAIL_DOMAIN='@p2p-tracker.app',COOLDOWN_MS=3000;
const BANCOS_DISPONIBLES=[{nombre:'Santander',moneda:'UYU'},{nombre:'BBVA',moneda:'UYU'},{nombre:'Itau',moneda:'UYU',especial:'itau'},{nombre:'Scotiabank',moneda:'UYU'},{nombre:'BROU',moneda:'UYU'},{nombre:'Prex',moneda:'UYU'},{nombre:'OCA',moneda:'UYU'},{nombre:'Mercado Pago',moneda:'UYU'},{nombre:'Midinero',moneda:'UYU'},{nombre:'Zelle',moneda:'USD'},{nombre:'Zinli',moneda:'USD'},{nombre:'Skrill',moneda:'USD'}];

// Utilidades
function fixNegativeZero(n){return Object.is(n,-0)?0:Math.round(n*100)/100}
function getComisionDecimal(){return(datos.comisionPlataforma||0.14)/100}
function toggleSeccion(id){document.getElementById(id).classList.toggle('open')}
function cambiarPagina(dir){const total=Math.ceil(datos.operaciones.length/POR_PAGINA);paginaActual+=dir;if(paginaActual<1)paginaActual=1;if(paginaActual>total)paginaActual=total;actualizarTablaOperaciones()}
function parsearTasa(valor){if(!valor)return null;const limpio=valor.toString().replace(',','.').trim();if(!/^\d+(\.\d{1,2})?$/.test(limpio))return null;const num=parseFloat(limpio);return isNaN(num)||num<=0?null:num}
function parsearComision(valor){if(!valor)return null;const limpio=valor.toString().replace(',','.').trim();if(!/^\d+(\.\d{1,2})?$/.test(limpio))return null;const num=parseFloat(limpio);return isNaN(num)||num<0||num>10?null:num}
function formatearTasa(num){return num.toFixed(2)}
function formatearNumero(n,d=2){return n.toLocaleString('es-UY',{minimumFractionDigits:d,maximumFractionDigits:d})}
function truncar(n,d=2){return Math.floor(n*Math.pow(10,d))/Math.pow(10,d)}

// Zona horaria Uruguay (UTC-3)
function getUruguayDate(){
    const now=new Date();
    const utc=now.getTime()+now.getTimezoneOffset()*60000;
    return new Date(utc-3*3600000);
}
function getUruguayDateString(){
    const d=getUruguayDate();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function getUruguayResetTime(){
    const d=getUruguayDate();
    d.setHours(0,30,0,0);
    return d;
}

// Cooldown para evitar duplicados
function activarCooldown(){
    enCooldown=true;
    document.getElementById('cooldownOverlay').classList.remove('hidden');
    setTimeout(()=>{
        enCooldown=false;
        document.getElementById('cooldownOverlay').classList.add('hidden');
    },COOLDOWN_MS);
}

// L√≠mites diarios
function verificarResetLimites(){
    const ahora=getUruguayDate();
    const horaReset=0.5; // 12:30 AM = 0.5 horas
    const horaActual=ahora.getHours()+ahora.getMinutes()/60;
    
    BANCOS_DISPONIBLES.forEach(b=>{
        if(!datos.bancos[b.nombre])return;
        const banco=datos.bancos[b.nombre];
        if(!banco.ultimoResetLimite)banco.ultimoResetLimite=null;
        
        const hoy=getUruguayDateString();
        const ultimoReset=banco.ultimoResetLimite;
        
        // Regla especial ITAU: s√°b-dom-lun cuentan como un d√≠a
        if(b.especial==='itau'){
            const diaSemana=ahora.getDay(); // 0=dom,1=lun,6=s√°b
            if(diaSemana===2&&horaActual>=horaReset){ // Martes despu√©s de 12:30
                if(ultimoReset!==hoy){
                    banco.limiteUsado=0;
                    banco.ultimoResetLimite=hoy;
                }
            }else if(diaSemana>2&&diaSemana<6&&horaActual>=horaReset){
                if(ultimoReset!==hoy){
                    banco.limiteUsado=0;
                    banco.ultimoResetLimite=hoy;
                }
            }
        }else{
            // Reset normal a las 12:30 AM
            if(horaActual>=horaReset&&ultimoReset!==hoy){
                banco.limiteUsado=0;
                banco.ultimoResetLimite=hoy;
            }
        }
    });
}

function guardarComisionYCalcular(){const input=document.getElementById('comisionPlataforma');const valor=parsearComision(input.value);if(valor!==null){datos.comisionPlataforma=valor;document.getElementById('comisionPctLabel').textContent=valor.toFixed(2);guardarDatos()}calcularPreview()}

// Auth
function switchAuthTab(t){document.getElementById('tabLogin').classList.toggle('active',t==='login');document.getElementById('tabRegister').classList.toggle('active',t==='register');document.getElementById('loginForm').style.display=t==='login'?'block':'none';document.getElementById('registerForm').style.display=t==='register'?'block':'none';hideAuthError()}
function showAuthError(m){const e=document.getElementById('authError');e.textContent=m;e.classList.add('show')}
function hideAuthError(){document.getElementById('authError').classList.remove('show')}
function userToEmail(u){return u.toLowerCase().trim()+EMAIL_DOMAIN}
function emailToUser(e){return e.replace(EMAIL_DOMAIN,'')}
async function handleRegister(e){e.preventDefault();hideAuthError();const u=document.getElementById('regUser').value.trim(),p=document.getElementById('regPass').value,p2=document.getElementById('regPassConfirm').value;if(!/^[a-zA-Z0-9_-]{3,20}$/.test(u))return showAuthError('Usuario inv√°lido');if(p.length<6)return showAuthError('M√≠nimo 6 caracteres');if(p!==p2)return showAuthError('No coinciden');const b=document.getElementById('registerBtn');b.disabled=true;b.textContent='Creando...';try{await auth.createUserWithEmailAndPassword(userToEmail(u),p)}catch(err){showAuthError(err.code==='auth/email-already-in-use'?'Usuario ya existe':'Error');b.disabled=false;b.textContent='Crear Cuenta'}}
async function handleLogin(e){e.preventDefault();hideAuthError();const u=document.getElementById('loginUser').value.trim(),p=document.getElementById('loginPass').value,b=document.getElementById('loginBtn');b.disabled=true;b.textContent='Entrando...';try{await auth.signInWithEmailAndPassword(userToEmail(u),p)}catch(err){showAuthError('Usuario o contrase√±a incorrectos');b.disabled=false;b.textContent='Iniciar Sesi√≥n'}}
async function cerrarSesion(){if(confirm('¬øCerrar sesi√≥n?')){if(unsubscribe)unsubscribe();await auth.signOut()}}
function showApp(u){currentUser=u;document.getElementById('menuUserName').textContent=emailToUser(u.email);document.getElementById('menuUserEmail').textContent=u.email;document.getElementById('authContainer').classList.add('hidden');document.getElementById('appContainer').classList.add('active');cargarDatosUsuario()}
function showAuth(){currentUser=null;document.getElementById('authContainer').classList.remove('hidden');document.getElementById('appContainer').classList.remove('active');['loginBtn','registerBtn'].forEach(id=>{const b=document.getElementById(id);b.disabled=false;b.textContent=id==='loginBtn'?'Iniciar Sesi√≥n':'Crear Cuenta'});['loginUser','loginPass','regUser','regPass','regPassConfirm'].forEach(id=>document.getElementById(id).value='');ocultarLoading()}
function inicializarFirebase(){if(typeof firebase==='undefined'){ocultarLoading();return}firebase.initializeApp(firebaseConfig);auth=firebase.auth();db=firebase.firestore();db.enablePersistence().catch(()=>{});auth.onAuthStateChanged(u=>u?showApp(u):showAuth())}

function cargarDatosUsuario(){
    if(!currentUser)return;
    if(unsubscribe)unsubscribe();
    unsubscribe=db.collection('users').doc(currentUser.uid).onSnapshot(doc=>{
        if(doc.exists){
            const d=doc.data();
            datos={
                operaciones:d.operaciones||[],
                movimientos:d.movimientos||[],
                transferencias:d.transferencias||[],
                bancos:d.bancos||{},
                saldoUsdt:d.saldoUsdt||0,
                ultimaTasaCompra:d.ultimaTasaCompra||0,
                ultimaTasaVenta:d.ultimaTasaVenta||0,
                comisionPlataforma:d.comisionPlataforma!==undefined?d.comisionPlataforma:0.14
            };
        }else{
            datos={operaciones:[],movimientos:[],transferencias:[],bancos:{},saldoUsdt:0,ultimaTasaCompra:0,ultimaTasaVenta:0,comisionPlataforma:0.14};
        }
        inicializarBancos();
        verificarResetLimites();
        paginaActual=1;
        document.getElementById('comisionPlataforma').value=datos.comisionPlataforma.toFixed(2);
        document.getElementById('comisionPctLabel').textContent=datos.comisionPlataforma.toFixed(2);
        actualizarVista();
        actualizarFormulario();
        ocultarLoading();
        setSyncStatus('online','‚úì');
    },()=>{setSyncStatus('offline','‚úó');ocultarLoading()});
}

async function guardarDatos(){if(!currentUser)return;setSyncStatus('syncing','...');try{await db.collection('users').doc(currentUser.uid).set({...datos,ultimaActualizacion:firebase.firestore.FieldValue.serverTimestamp()});setSyncStatus('online','‚úì')}catch(e){setSyncStatus('offline','‚úó')}}
function setSyncStatus(s,t){document.getElementById('syncStatus').className='sync-status '+s;document.getElementById('syncText').textContent=t}
function ocultarLoading(){document.getElementById('loadingOverlay').classList.add('hidden')}
function toggleMenu(){document.getElementById('menuBtn').classList.toggle('active');document.getElementById('menuDropdown').classList.toggle('active')}
function cerrarMenu(){document.getElementById('menuBtn').classList.remove('active');document.getElementById('menuDropdown').classList.remove('active')}
document.addEventListener('click',e=>{const m=document.querySelector('.menu-container');if(m&&!m.contains(e.target))cerrarMenu()});

function inicializarBancos(){
    BANCOS_DISPONIBLES.forEach(b=>{
        if(!datos.bancos[b.nombre]){
            datos.bancos[b.nombre]={activo:false,saldo:0,limiteDiario:0,limiteUsado:0,ultimoResetLimite:null};
        }else{
            // Asegurar campos nuevos
            if(datos.bancos[b.nombre].limiteDiario===undefined)datos.bancos[b.nombre].limiteDiario=0;
            if(datos.bancos[b.nombre].limiteUsado===undefined)datos.bancos[b.nombre].limiteUsado=0;
            if(datos.bancos[b.nombre].ultimoResetLimite===undefined)datos.bancos[b.nombre].ultimoResetLimite=null;
        }
    });
}

function actualizarFormulario(){
    const t=document.getElementById('tipo').value;
    document.getElementById('montoLabel').textContent=t==='compra'?'Pag√°s (UYU)':'Recib√≠s (UYU)';
    document.getElementById('bancoLabel').textContent=t==='compra'?'Sale de *':'Entra a *';
    document.getElementById('comisionBancoGroup').style.display=t==='compra'?'block':'none';
    if(t==='venta')document.getElementById('comisionBanco').value='0';
    const tasaInput=document.getElementById('tasa');
    if(t==='compra'&&datos.ultimaTasaCompra>0){tasaInput.value=formatearTasa(datos.ultimaTasaCompra)}
    else if(t==='venta'&&datos.ultimaTasaVenta>0){tasaInput.value=formatearTasa(datos.ultimaTasaVenta)}
    calcularPreview();
}

function actualizarSelectBancos(){
    const s=document.getElementById('banco'),v=s.value;
    s.innerHTML='<option value="">-- Seleccionar --</option>';
    BANCOS_DISPONIBLES.forEach(b=>{if(datos.bancos[b.nombre]?.activo)s.innerHTML+=`<option value="${b.nombre}">${b.nombre}</option>`});
    s.value=v;
}

function mostrarSaldoBanco(){
    const b=document.getElementById('banco').value,i=document.getElementById('saldoBancoInfo'),h=document.getElementById('bancoHelp');
    h.textContent='';h.className='';
    if(b&&datos.bancos[b]){
        const bi=BANCOS_DISPONIBLES.find(x=>x.nombre===b);
        i.textContent=' | '+b+': '+(bi?.moneda==='USD'?'US$':'$')+formatearNumero(datos.bancos[b].saldo);
    }else i.textContent='';
}

function calcularPreview(){
    const t=document.getElementById('tipo').value;
    const m=parseFloat(document.getElementById('monto').value)||0;
    const ta=parsearTasa(document.getElementById('tasa').value);
    const comisionPct=getComisionDecimal();
    document.getElementById('tasa').classList.remove('error');
    document.getElementById('tasaHelp').className='';
    document.getElementById('tasaHelp').textContent='Ej: 39.50';
    if(m>0&&ta){
        const u=m/ta,c=truncar(u*comisionPct,2);
        document.getElementById('comisionPlataformaInfo').textContent=formatearNumero(c,2)+' USDT';
        document.getElementById('previewText').innerHTML=t==='compra'?`üì• Recib√≠s <b>${formatearNumero(u-c,2)} USDT</b>`:`üì§ Entreg√°s <b>${formatearNumero(u+c,2)} USDT</b>`;
        document.getElementById('previewBox').style.display='block';
    }else{
        document.getElementById('previewBox').style.display='none';
        document.getElementById('comisionPlataformaInfo').textContent='0 USDT';
    }
}

async function agregarOperacion(){
    if(enCooldown)return;
    const btn=document.getElementById('btnAgregarOp');
    if(btn.disabled)return;
    
    const t=document.getElementById('tipo').value;
    const m=parseFloat(document.getElementById('monto').value);
    const tasaInput=document.getElementById('tasa');
    const ta=parsearTasa(tasaInput.value);
    const b=document.getElementById('banco').value;
    const cb=parseFloat(document.getElementById('comisionBanco').value)||0;
    const f=document.getElementById('fecha').value;
    const comisionPct=getComisionDecimal();
    
    if(!m){alert('Ingres√° el monto');return}
    if(!ta){tasaInput.classList.add('error');document.getElementById('tasaHelp').textContent='Formato inv√°lido';document.getElementById('tasaHelp').className='error-text';alert('Tasa inv√°lida (ej: 39.50)');return}
    if(!b){document.getElementById('bancoHelp').textContent='Seleccion√° un banco';document.getElementById('bancoHelp').className='error-text';document.getElementById('banco').classList.add('error');alert('Seleccion√° un banco');return}
    document.getElementById('banco').classList.remove('error');
    if(!f){alert('Seleccion√° la fecha');return}
    
    const u=m/ta,cp=truncar(u*comisionPct,2);
    if(t==='compra'&&datos.bancos[b]&&datos.bancos[b].saldo<m+cb&&!confirm('Saldo insuficiente en '+b+'. ¬øContinuar?'))return;
    
    btn.disabled=true;
    btn.textContent='Guardando...';
    
    try{
        datos.operaciones.unshift({id:Date.now(),tipo:t,monto:m,tasa:ta,usdt:u,banco:b,comisionBanco:t==='compra'?cb:0,comisionPlataforma:cp,comisionPct:datos.comisionPlataforma,fecha:f,timestamp:new Date().toISOString()});
        
        if(t==='compra'){
            datos.ultimaTasaCompra=ta;
            datos.bancos[b].saldo=fixNegativeZero(datos.bancos[b].saldo-(m+cb));
            datos.saldoUsdt=fixNegativeZero(datos.saldoUsdt+(u-cp));
        }else{
            datos.ultimaTasaVenta=ta;
            datos.bancos[b].saldo=fixNegativeZero(datos.bancos[b].saldo+m);
            datos.saldoUsdt=fixNegativeZero(datos.saldoUsdt-(u+cp));
        }
        
        document.getElementById('monto').value='';
        document.getElementById('comisionBanco').value='0';
        document.getElementById('previewBox').style.display='none';
        paginaActual=1;
        
        await guardarDatos();
        actualizarVista();
        activarCooldown();
    }finally{
        btn.disabled=false;
        btn.textContent='Agregar Operaci√≥n';
    }
}

async function eliminarOperacion(id){
    if(!confirm('¬øEliminar operaci√≥n?'))return;
    const op=datos.operaciones.find(o=>o.id===id);
    if(op){
        if(op.tipo==='compra'){
            if(op.banco&&datos.bancos[op.banco])datos.bancos[op.banco].saldo=fixNegativeZero(datos.bancos[op.banco].saldo+(op.monto+(op.comisionBanco||0)));
            datos.saldoUsdt=fixNegativeZero(datos.saldoUsdt-(op.usdt-op.comisionPlataforma));
        }else{
            if(op.banco&&datos.bancos[op.banco])datos.bancos[op.banco].saldo=fixNegativeZero(datos.bancos[op.banco].saldo-op.monto);
            datos.saldoUsdt=fixNegativeZero(datos.saldoUsdt+(op.usdt+op.comisionPlataforma));
        }
    }
    datos.operaciones=datos.operaciones.filter(o=>o.id!==id);
    await guardarDatos();
    actualizarVista();
}

// Movimientos
function abrirModalMovimiento(){
    guardandoMovimiento=false;
    tipoMovimiento='ingreso';
    document.getElementById('tabIngreso').classList.add('active','tab-ingreso');
    document.getElementById('tabIngreso').classList.remove('tab-egreso');
    document.getElementById('tabEgreso').classList.remove('active','tab-egreso');
    document.getElementById('movTipoCuenta').value='banco';
    document.getElementById('movMonto').value='';
    document.getElementById('movDescripcion').value='';
    document.getElementById('movFecha').valueAsDate=new Date();
    document.getElementById('btnGuardarMov').disabled=false;
    document.getElementById('btnGuardarMov').textContent='Guardar';
    actualizarCuentasMovimiento();
    document.getElementById('modalMovimiento').classList.add('active');
}
function cerrarModalMovimiento(){document.getElementById('modalMovimiento').classList.remove('active')}
function setTipoMovimiento(t){
    tipoMovimiento=t;
    const tabIng=document.getElementById('tabIngreso');
    const tabEgr=document.getElementById('tabEgreso');
    tabIng.classList.toggle('active',t==='ingreso');
    tabIng.classList.toggle('tab-ingreso',t==='ingreso');
    tabEgr.classList.toggle('active',t==='egreso');
    tabEgr.classList.toggle('tab-egreso',t==='egreso');
}
function actualizarCuentasMovimiento(){
    const tc=document.getElementById('movTipoCuenta').value;
    document.getElementById('movBancoGroup').style.display=tc==='usdt'?'none':'block';
    document.getElementById('movMontoLabel').textContent=tc==='usdt'?'Monto (USDT)':'Monto';
    if(tc!=='usdt'){
        const s=document.getElementById('movBanco');
        s.innerHTML='<option value="">Seleccionar banco</option>';
        BANCOS_DISPONIBLES.forEach(b=>{if(datos.bancos[b.nombre]?.activo)s.innerHTML+=`<option value="${b.nombre}">${b.nombre}</option>`});
    }
}

async function guardarMovimiento(){
    if(guardandoMovimiento||enCooldown)return;
    const btn=document.getElementById('btnGuardarMov');
    const tc=document.getElementById('movTipoCuenta').value;
    const b=document.getElementById('movBanco').value;
    const m=parseFloat(document.getElementById('movMonto').value);
    const desc=document.getElementById('movDescripcion').value;
    const f=document.getElementById('movFecha').value;
    
    if(!m||m<=0)return alert('Monto inv√°lido');
    if(tc==='banco'&&!b)return alert('Seleccion√° un banco');
    
    guardandoMovimiento=true;
    btn.disabled=true;
    btn.textContent='Guardando...';
    
    try{
        // Calcular valor en UYU para egresos (para descontar de ganancia)
        let valorUYU=m;
        if(tc==='usdt'&&tipoMovimiento==='egreso'){
            // Usar √∫ltima tasa de compra para convertir USDT a UYU
            valorUYU=m*(datos.ultimaTasaCompra||1);
        }
        
        datos.movimientos.unshift({
            id:Date.now(),
            tipoMovimiento,
            tipoCuenta:tc,
            banco:tc==='banco'?b:null,
            monto:m,
            valorUYU:tipoMovimiento==='egreso'?valorUYU:0,
            descripcion:desc,
            fecha:f,
            timestamp:new Date().toISOString()
        });
        
        if(tc==='usdt'){
            datos.saldoUsdt=fixNegativeZero(datos.saldoUsdt+(tipoMovimiento==='ingreso'?m:-m));
        }else{
            datos.bancos[b].saldo=fixNegativeZero(datos.bancos[b].saldo+(tipoMovimiento==='ingreso'?m:-m));
        }
        
        await guardarDatos();
        actualizarVista();
        cerrarModalMovimiento();
        activarCooldown();
    }finally{
        guardandoMovimiento=false;
        btn.disabled=false;
        btn.textContent='Guardar';
    }
}

async function eliminarMovimiento(id){
    if(!confirm('¬øEliminar?'))return;
    const mov=datos.movimientos.find(m=>m.id===id);
    if(mov){
        if(mov.tipoCuenta==='usdt')datos.saldoUsdt=fixNegativeZero(datos.saldoUsdt+(mov.tipoMovimiento==='ingreso'?-mov.monto:mov.monto));
        else if(mov.banco&&datos.bancos[mov.banco])datos.bancos[mov.banco].saldo=fixNegativeZero(datos.bancos[mov.banco].saldo+(mov.tipoMovimiento==='ingreso'?-mov.monto:mov.monto));
    }
    datos.movimientos=datos.movimientos.filter(m=>m.id!==id);
    await guardarDatos();
    actualizarVista();
}

// Bancos
function abrirModalBancos(){renderizarListaBancos();document.getElementById('modalBancos').classList.add('active')}
function cerrarModalBancos(){document.getElementById('modalBancos').classList.remove('active');guardarDatos();actualizarVista()}
function renderizarListaBancos(){
    let h='';
    BANCOS_DISPONIBLES.forEach(b=>{
        const a=datos.bancos[b.nombre]?.activo||false;
        const s=datos.bancos[b.nombre]?.saldo||0;
        const lim=datos.bancos[b.nombre]?.limiteDiario||0;
        let limInfo=lim>0?` | L√≠mite: ${b.moneda==='USD'?'US$':'$'}${formatearNumero(lim,0)}/d√≠a`:'';
        if(b.especial==='itau')limInfo+=' (s√°b-lun=1d√≠a)';
        h+=`<div class="banco-list-item"><div><div style="font-weight:600;font-size:0.9em">${b.nombre} <span style="color:#94a3b8">(${b.moneda})</span></div><div style="color:#64748b;font-size:0.8em">${b.moneda==='USD'?'US$':'$'}${formatearNumero(s)}${limInfo}</div></div><div class="banco-list-actions"><button class="btn-edit-small" onclick="abrirEditarSaldo('${b.nombre}')">Editar</button><label class="toggle-switch"><input type="checkbox" ${a?'checked':''} onchange="toggleBanco('${b.nombre}')"><span class="toggle-slider"></span></label></div></div>`;
    });
    document.getElementById('listaBancos').innerHTML=h;
}
function toggleBanco(n){if(!datos.bancos[n])datos.bancos[n]={activo:false,saldo:0,limiteDiario:0,limiteUsado:0};datos.bancos[n].activo=!datos.bancos[n].activo;guardarDatos();renderizarListaBancos()}

function abrirEditarSaldo(n){
    bancoEditando=n;
    const isUSDT=n==='USDT';
    document.getElementById('editarSaldoHeader').textContent=isUSDT?'Editar USDT':'Editar '+n;
    document.getElementById('nuevoSaldoBanco').value=isUSDT?datos.saldoUsdt:(datos.bancos[n]?.saldo||0);
    document.getElementById('limiteDiarioGroup').style.display=isUSDT?'none':'block';
    if(!isUSDT){
        document.getElementById('limiteDiarioBanco').value=datos.bancos[n]?.limiteDiario||0;
    }
    document.getElementById('modalEditarSaldo').classList.add('active');
}
function cerrarModalEditarSaldo(){document.getElementById('modalEditarSaldo').classList.remove('active');bancoEditando=null}

async function guardarNuevoSaldo(){
    const ns=parseFloat(document.getElementById('nuevoSaldoBanco').value)||0;
    if(bancoEditando==='USDT'){
        datos.saldoUsdt=fixNegativeZero(ns);
    }else if(bancoEditando&&datos.bancos[bancoEditando]){
        datos.bancos[bancoEditando].saldo=fixNegativeZero(ns);
        const lim=parseFloat(document.getElementById('limiteDiarioBanco').value)||0;
        datos.bancos[bancoEditando].limiteDiario=lim;
    }
    await guardarDatos();
    actualizarVista();
    renderizarListaBancos();
    cerrarModalEditarSaldo();
}

// Transferencias
function abrirModalTransferencia(){
    document.getElementById('fechaTransferencia').valueAsDate=new Date();
    document.getElementById('montoTransferencia').value='';
    document.getElementById('comisionTransferencia').value='0';
    const opts='<option value="">Seleccionar</option>'+BANCOS_DISPONIBLES.filter(b=>datos.bancos[b.nombre]?.activo).map(b=>`<option value="${b.nombre}">${b.nombre}</option>`).join('');
    document.getElementById('bancoOrigen').innerHTML=opts;
    document.getElementById('bancoDestino').innerHTML=opts;
    document.getElementById('saldoOrigenInfo').textContent='';
    document.getElementById('btnTransferir').disabled=false;
    document.getElementById('modalTransferencia').classList.add('active');
}
function cerrarModalTransferencia(){document.getElementById('modalTransferencia').classList.remove('active')}
function mostrarSaldoOrigen(){
    const b=document.getElementById('bancoOrigen').value;
    if(b&&datos.bancos[b]){
        const bi=BANCOS_DISPONIBLES.find(x=>x.nombre===b);
        let info='Disponible: '+(bi?.moneda==='USD'?'US$':'$')+formatearNumero(datos.bancos[b].saldo);
        if(datos.bancos[b].limiteDiario>0){
            const usado=datos.bancos[b].limiteUsado||0;
            const disponible=datos.bancos[b].limiteDiario-usado;
            info+=` | L√≠mite hoy: ${formatearNumero(disponible,0)}`;
        }
        document.getElementById('saldoOrigenInfo').textContent=info;
    }else{
        document.getElementById('saldoOrigenInfo').textContent='';
    }
}

async function realizarTransferencia(){
    if(enCooldown)return;
    const btn=document.getElementById('btnTransferir');
    if(btn.disabled)return;
    
    const o=document.getElementById('bancoOrigen').value;
    const d=document.getElementById('bancoDestino').value;
    const m=parseFloat(document.getElementById('montoTransferencia').value);
    const c=parseFloat(document.getElementById('comisionTransferencia').value)||0;
    const f=document.getElementById('fechaTransferencia').value;
    
    if(!o||!d||o===d)return alert('Seleccion√° bancos diferentes');
    if(!m||m<=0)return alert('Monto inv√°lido');
    
    // Verificar l√≠mite diario
    if(datos.bancos[o].limiteDiario>0){
        const usado=datos.bancos[o].limiteUsado||0;
        const disponible=datos.bancos[o].limiteDiario-usado;
        if(m+c>disponible){
            return alert(`Excede el l√≠mite diario. Disponible: $${formatearNumero(disponible,0)}`);
        }
    }
    
    btn.disabled=true;
    btn.textContent='Transfiriendo...';
    
    try{
        datos.transferencias.unshift({id:Date.now(),origen:o,destino:d,monto:m,comision:c,fecha:f,timestamp:new Date().toISOString()});
        datos.bancos[o].saldo=fixNegativeZero(datos.bancos[o].saldo-(m+c));
        datos.bancos[d].saldo=fixNegativeZero(datos.bancos[d].saldo+m);
        
        // Actualizar l√≠mite usado
        if(datos.bancos[o].limiteDiario>0){
            datos.bancos[o].limiteUsado=(datos.bancos[o].limiteUsado||0)+(m+c);
        }
        
        await guardarDatos();
        actualizarVista();
        cerrarModalTransferencia();
        activarCooldown();
    }finally{
        btn.disabled=false;
        btn.textContent='Transferir';
    }
}

async function eliminarTransferencia(id){
    if(!confirm('¬øEliminar?'))return;
    const t=datos.transferencias.find(x=>x.id===id);
    if(t){
        datos.bancos[t.origen].saldo=fixNegativeZero(datos.bancos[t.origen].saldo+(t.monto+t.comision));
        datos.bancos[t.destino].saldo=fixNegativeZero(datos.bancos[t.destino].saldo-t.monto);
    }
    datos.transferencias=datos.transferencias.filter(x=>x.id!==id);
    await guardarDatos();
    actualizarVista();
}

// Calendario
function abrirCalendario(){calendarDate=new Date();renderizarCalendario();document.getElementById('modalCalendario').classList.add('active')}
function cerrarCalendario(){document.getElementById('modalCalendario').classList.remove('active')}
function cambiarMes(d){calendarDate.setMonth(calendarDate.getMonth()+d);renderizarCalendario()}

function calcularGananciaDiaria(){
    const g={};
    const tasaPromC=calcularTasaPromedioCompra();
    
    // Ganancias por operaciones de venta
    datos.operaciones.forEach(op=>{
        if(!g[op.fecha])g[op.fecha]=0;
        if(op.tipo==='venta'&&tasaPromC>0){
            const spread=op.tasa-tasaPromC;
            g[op.fecha]+=(op.usdt+op.comisionPlataforma)*spread;
        }
    });
    
    // Restar egresos externos
    datos.movimientos.forEach(mov=>{
        if(mov.tipoMovimiento==='egreso'){
            if(!g[mov.fecha])g[mov.fecha]=0;
            // Si es USDT, usar valorUYU guardado o calcular
            if(mov.tipoCuenta==='usdt'){
                const valorUYU=mov.valorUYU||(mov.monto*(datos.ultimaTasaCompra||1));
                g[mov.fecha]-=valorUYU;
            }else{
                g[mov.fecha]-=mov.monto;
            }
        }
    });
    
    return g;
}

function calcularTasaPromedioCompra(){const c=datos.operaciones.filter(o=>o.tipo==='compra');return c.length?c.reduce((s,o)=>s+o.tasa,0)/c.length:0}

function renderizarCalendario(){
    const y=calendarDate.getFullYear(),mo=calendarDate.getMonth();
    document.getElementById('calendarMonth').textContent=`${y}-${String(mo+1).padStart(2,'0')}`;
    const fd=new Date(y,mo,1).getDay(),dm=new Date(y,mo+1,0).getDate(),hoy=new Date(),g=calcularGananciaDiaria();
    let h='',tg=0,tp=0;
    
    for(let i=0;i<fd;i++)h+='<div class="calendar-day empty"></div>';
    for(let d=1;d<=dm;d++){
        const ds=`${y}-${String(mo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const val=g[ds]||0;
        const isHoy=hoy.getFullYear()===y&&hoy.getMonth()===mo&&hoy.getDate()===d;
        let cls='calendar-day';
        if(val>0){cls+=' positive';tg+=val}
        else if(val<0){cls+=' negative';tp+=Math.abs(val)}
        if(isHoy)cls+=' today';
        const vs=val!==0?(val>0?'+':'')+formatearNumero(val,0):'0';
        const vc=val>0?'pos':val<0?'neg':'';
        h+=`<div class="${cls}"><div class="calendar-day-number">${d}</div><div class="calendar-day-value ${vc}">${vs}</div></div>`;
    }
    document.getElementById('calendarDays').innerHTML=h;
    
    // Ganancia total
    const gananciaTotal=calcularGananciaTotal();
    const gtEl=document.getElementById('calGananciaTotal');
    gtEl.textContent=(gananciaTotal>=0?'+':'-')+'$'+formatearNumero(Math.abs(gananciaTotal),0);
    gtEl.className='calendar-stat-value '+(gananciaTotal>=0?'positive':'negative');
    
    document.getElementById('calGanancias').textContent='+$'+formatearNumero(tg,0);
    document.getElementById('calPerdidas').textContent='-$'+formatearNumero(tp,0);
}

// C√°lculo de ganancia total corregido
function calcularGananciaTotal(){
    let ganancia=0;
    const tasaPromC=calcularTasaPromedioCompra();
    let comisionesBanco=0;
    
    // Ganancias por spread en ventas
    datos.operaciones.forEach(op=>{
        if(op.tipo==='compra'){
            comisionesBanco+=op.comisionBanco||0;
        }else if(op.tipo==='venta'&&tasaPromC>0){
            const spread=op.tasa-tasaPromC;
            ganancia+=(op.usdt+op.comisionPlataforma)*spread;
        }
    });
    
    // Restar comisiones de banco
    ganancia-=comisionesBanco;
    
    // Restar egresos externos
    datos.movimientos.forEach(mov=>{
        if(mov.tipoMovimiento==='egreso'){
            if(mov.tipoCuenta==='usdt'){
                const valorUYU=mov.valorUYU||(mov.monto*(datos.ultimaTasaCompra||1));
                ganancia-=valorUYU;
            }else{
                ganancia-=mov.monto;
            }
        }
    });
    
    return ganancia;
}

function calcularGananciaHoy(){
    const hoy=getUruguayDateString();
    const g=calcularGananciaDiaria();
    return g[hoy]||0;
}

function calcularResumen(){
    let tp=0,tr=0,uc=0,uv=0,cb=0,stc=0,stv=0,cc=0,cv=0;
    datos.operaciones.forEach(op=>{
        if(op.tipo==='compra'){
            tp+=op.monto+(op.comisionBanco||0);
            uc+=op.usdt-op.comisionPlataforma;
            cb+=op.comisionBanco||0;
            stc+=op.tasa;cc++;
        }else{
            tr+=op.monto;
            uv+=op.usdt+op.comisionPlataforma;
            stv+=op.tasa;cv++;
        }
    });
    const tpc=cc?stc/cc:0,tpv=cv?stv/cv:0,sp=tpv-tpc,ucr=Math.min(uc,uv);
    let tb=0;
    BANCOS_DISPONIBLES.forEach(b=>{if(datos.bancos[b.nombre]?.activo&&b.moneda==='UYU')tb+=datos.bancos[b.nombre].saldo});
    
    // Contar operaciones de hoy
    const hoy=getUruguayDateString();
    const opsHoy=datos.operaciones.filter(o=>o.fecha===hoy).length;
    
    return{totalPagado:tp,totalRecibido:tr,usdtComprados:uc,usdtVendidos:uv,usdtCerrados:ucr,tasaPromC:tpc,tasaPromV:tpv,spread:sp,pctSpread:tpc?(sp/tpc)*100:0,totalBancosUYU:tb,opsHoy};
}

function actualizarVista(){
    const r=calcularResumen();
    
    // Ganancia del d√≠a
    const gananciaHoy=calcularGananciaHoy();
    const ghEl=document.getElementById('gananciaHoy');
    const cardHoy=document.getElementById('cardGananciaHoy');
    if(gananciaHoy>=0){
        ghEl.textContent='+$'+formatearNumero(gananciaHoy);
        ghEl.className='card-value positive';
        cardHoy.className='card main-card';
    }else{
        ghEl.textContent='-$'+formatearNumero(Math.abs(gananciaHoy));
        ghEl.className='card-value negative';
        cardHoy.className='card main-card negative';
    }
    
    // Fecha de hoy
    const uruguayDate=getUruguayDate();
    const diasSemana=['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
    document.getElementById('fechaHoy').textContent=diasSemana[uruguayDate.getDay()]+' '+uruguayDate.getDate()+'/'+(uruguayDate.getMonth()+1);
    document.getElementById('opsHoy').textContent=r.opsHoy+' ops hoy';
    
    document.getElementById('usdtEnTenencia').textContent=formatearNumero(Math.max(0,datos.saldoUsdt),2);
    document.getElementById('totalBancos').textContent='$'+formatearNumero(r.totalBancosUYU,0);
    document.getElementById('totalPagado').textContent='$'+formatearNumero(r.totalPagado,0);
    document.getElementById('tasaPromCompra').textContent='$'+formatearNumero(r.tasaPromC);
    document.getElementById('totalRecibido').textContent='$'+formatearNumero(r.totalRecibido,0);
    document.getElementById('tasaPromVenta').textContent='$'+formatearNumero(r.tasaPromV);
    document.getElementById('spreadPromedio').textContent='$'+formatearNumero(r.spread);
    document.getElementById('porcentajeSpread').textContent=formatearNumero(r.pctSpread,1)+'%';
    
    actualizarBancosGrid();
    actualizarSelectBancos();
    actualizarTablaOperaciones();
    actualizarTablaMovimientos();
    actualizarTablaTransferencias();
}

function actualizarBancosGrid(){
    let h=`<div class="banco-mini-card usdt-card" onclick="abrirEditarSaldo('USDT')"><div class="banco-nombre">ü™ô USDT</div><div class="banco-saldo">${formatearNumero(Math.max(0,datos.saldoUsdt),2)}</div><div class="banco-moneda">Tether</div></div>`;
    
    BANCOS_DISPONIBLES.forEach(b=>{
        if(datos.bancos[b.nombre]?.activo){
            const s=datos.bancos[b.nombre].saldo;
            const lim=datos.bancos[b.nombre].limiteDiario||0;
            const usado=datos.bancos[b.nombre].limiteUsado||0;
            let limiteHtml='';
            
            if(lim>0){
                const pct=Math.min(100,(usado/lim)*100);
                let fillClass='';
                if(pct>=90)fillClass='danger';
                else if(pct>=70)fillClass='warning';
                limiteHtml=`<div class="banco-limite">L√≠mite: ${formatearNumero(lim-usado,0)}/${formatearNumero(lim,0)}</div><div class="banco-limite-bar"><div class="banco-limite-fill ${fillClass}" style="width:${pct}%"></div></div>`;
            }
            
            h+=`<div class="banco-mini-card" onclick="abrirEditarSaldo('${b.nombre}')"><div class="banco-nombre">${b.nombre}</div><div class="banco-saldo" style="color:${s>=0?'#16a34a':'#dc2626'}">${b.moneda==='USD'?'US$':'$'}${formatearNumero(s)}</div><div class="banco-moneda">${b.moneda}</div>${limiteHtml}</div>`;
        }
    });
    document.getElementById('bancosGrid').innerHTML=h;
}

function actualizarTablaOperaciones(){
    const t=document.getElementById('tablaContent'),total=datos.operaciones.length;
    document.getElementById('totalOperaciones').textContent=total;
    if(!total){t.innerHTML='<div class="empty-state"><div class="empty-state-icon">üìù</div><div>Sin operaciones</div></div>';document.getElementById('paginationOp').style.display='none';return}
    const totalPaginas=Math.ceil(total/POR_PAGINA);
    if(paginaActual>totalPaginas)paginaActual=totalPaginas;
    const inicio=(paginaActual-1)*POR_PAGINA,fin=inicio+POR_PAGINA,ops=datos.operaciones.slice(inicio,fin);
    let h='<table><thead><tr><th>Tipo</th><th>Monto</th><th>Tasa</th><th>USDT</th><th>Banco</th><th>Fecha</th><th></th></tr></thead><tbody>';
    ops.forEach(op=>{
        const un=op.tipo==='compra'?op.usdt-op.comisionPlataforma:op.usdt+op.comisionPlataforma;
        const badge=op.tipo==='compra'?'<span class="badge badge-compra">üõí <b>Compra</b></span>':'<span class="badge badge-venta">üíµ <b>Venta</b></span>';
        h+=`<tr><td>${badge}</td><td><b>$${formatearNumero(op.monto)}</b></td><td>$${formatearNumero(op.tasa)}</td><td><b>${formatearNumero(un,2)}</b></td><td style="color:#0284c7">${op.banco||'-'}</td><td style="color:#64748b">${op.fecha}</td><td><button class="btn-delete" onclick="eliminarOperacion(${op.id})">√ó</button></td></tr>`;
    });
    t.innerHTML=h+'</tbody></table>';
    document.getElementById('paginationOp').style.display=totalPaginas>1?'flex':'none';
    document.getElementById('paginaInfoOp').textContent=`${paginaActual} / ${totalPaginas}`;
    document.getElementById('btnPrevOp').disabled=paginaActual===1;
    document.getElementById('btnNextOp').disabled=paginaActual===totalPaginas;
}

function actualizarTablaMovimientos(){
    const sec=document.getElementById('seccionMovimientos'),total=datos.movimientos.length;
    document.getElementById('totalMovimientos').textContent=total;
    if(!total){sec.style.display='none';return}
    sec.style.display='block';
    let h='<table><thead><tr><th>Tipo</th><th>Cuenta</th><th>Monto</th><th>Desc</th><th>Fecha</th><th></th></tr></thead><tbody>';
    datos.movimientos.forEach(m=>{
        const badge=m.tipoMovimiento==='ingreso'?'<span class="badge badge-ingreso">üì• <b>Ingreso</b></span>':'<span class="badge badge-egreso">üì§ <b>Egreso</b></span>';
        h+=`<tr><td>${badge}</td><td>${m.tipoCuenta==='usdt'?'ü™ô USDT':m.banco}</td><td><b>${m.tipoCuenta==='usdt'?'':'$'}${formatearNumero(m.monto)}${m.tipoCuenta==='usdt'?' USDT':''}</b></td><td style="color:#64748b;max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${m.descripcion||'-'}</td><td style="color:#64748b">${m.fecha}</td><td><button class="btn-delete" onclick="eliminarMovimiento(${m.id})">√ó</button></td></tr>`;
    });
    document.getElementById('movimientosContent').innerHTML=h+'</tbody></table>';
}

function actualizarTablaTransferencias(){
    const sec=document.getElementById('seccionTransferencias'),total=datos.transferencias.length;
    document.getElementById('totalTransferencias').textContent=total;
    if(!total){sec.style.display='none';return}
    sec.style.display='block';
    let h='<table><thead><tr><th>Origen</th><th>Destino</th><th>Monto</th><th>Com</th><th>Fecha</th><th></th></tr></thead><tbody>';
    datos.transferencias.forEach(tr=>{
        h+=`<tr><td style="color:#dc2626">${tr.origen}</td><td style="color:#16a34a">${tr.destino}</td><td><b>$${formatearNumero(tr.monto)}</b></td><td style="color:#ea580c">${tr.comision>0?'$'+formatearNumero(tr.comision):'-'}</td><td style="color:#64748b">${tr.fecha}</td><td><button class="btn-delete" onclick="eliminarTransferencia(${tr.id})">√ó</button></td></tr>`;
    });
    document.getElementById('transferenciasContent').innerHTML=h+'</tbody></table>';
}

function exportarDatos(){const b=new Blob([JSON.stringify(datos,null,2)],{type:'application/json'}),l=document.createElement('a');l.href=URL.createObjectURL(b);l.download='p2p-backup-'+new Date().toISOString().split('T')[0]+'.json';l.click()}

async function importarDatos(e){
    const f=e.target.files[0];if(!f)return;
    const r=new FileReader();
    r.onload=async ev=>{
        try{
            const d=JSON.parse(ev.target.result);
            datos={
                operaciones:d.operaciones||[],
                movimientos:d.movimientos||[],
                transferencias:d.transferencias||[],
                bancos:d.bancos||{},
                saldoUsdt:d.saldoUsdt||0,
                ultimaTasaCompra:d.ultimaTasaCompra||0,
                ultimaTasaVenta:d.ultimaTasaVenta||0,
                comisionPlataforma:d.comisionPlataforma!==undefined?d.comisionPlataforma:0.14
            };
            inicializarBancos();
            paginaActual=1;
            document.getElementById('comisionPlataforma').value=datos.comisionPlataforma.toFixed(2);
            document.getElementById('comisionPctLabel').textContent=datos.comisionPlataforma.toFixed(2);
            await guardarDatos();
            actualizarVista();
            alert('‚úÖ Importado');
        }catch(err){alert('‚ùå Error')}
    };
    r.readAsText(f);
    e.target.value='';
}

async function borrarTodo(){
    if(confirm('‚ö†Ô∏è ¬øBorrar TODO?')&&confirm('No se puede deshacer. ¬øContinuar?')){
        datos={operaciones:[],movimientos:[],transferencias:[],bancos:{},saldoUsdt:0,ultimaTasaCompra:0,ultimaTasaVenta:0,comisionPlataforma:0.14};
        inicializarBancos();
        paginaActual=1;
        document.getElementById('comisionPlataforma').value='0.14';
        document.getElementById('comisionPctLabel').textContent='0.14';
        await guardarDatos();
        actualizarVista();
    }
}

// Verificar reset de l√≠mites cada minuto
setInterval(()=>{
    verificarResetLimites();
    actualizarVista();
},60000);

document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('fecha').valueAsDate=new Date();
    actualizarFormulario();
    inicializarFirebase();
});
    </script>
</body>
</html>
