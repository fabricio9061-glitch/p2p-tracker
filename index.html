<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Registro P2P</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’±</text></svg>">
    <style>
        /* â•â•â• Reset & Base â•â•â• */
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f0f0ee;min-height:100vh}
        .container{max-width:1400px;margin:0 auto;padding:15px;padding-bottom:30px}

        /* â•â•â• Header â•â•â• */
        .header{text-align:center;margin-bottom:20px;padding-top:10px;position:relative}
        .header h1{color:#1e293b;font-size:1.8em;margin-bottom:5px}
        .header p{color:#64748b;font-size:0.9em}

        /* â•â•â• Sync â•â•â• */
        .sync-status{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:20px;font-size:0.75em;margin-top:8px}
        .sync-status.online{background:#dcfce7;color:#16a34a}
        .sync-status.offline{background:#fee2e2;color:#dc2626}
        .sync-status.syncing{background:#fef3c7;color:#d97706}
        .sync-dot{width:6px;height:6px;border-radius:50%;background:currentColor}

        /* â•â•â• Menu â•â•â• */
        .menu-container{position:absolute;top:10px;right:0}
        .menu-btn{background:white;border:1px solid #e2e8f0;border-radius:10px;padding:10px 12px;cursor:pointer;display:flex;flex-direction:column;gap:4px}
        .menu-btn span{display:block;width:20px;height:2px;background:#475569;border-radius:2px;transition:all 0.3s}
        .menu-btn.active span:nth-child(1){transform:rotate(45deg) translate(4px,4px)}
        .menu-btn.active span:nth-child(2){opacity:0}
        .menu-btn.active span:nth-child(3){transform:rotate(-45deg) translate(4px,-4px)}
        .menu-dropdown{position:absolute;top:50px;right:0;background:white;border:1px solid #e2e8f0;border-radius:12px;padding:8px;min-width:200px;box-shadow:0 10px 40px rgba(0,0,0,0.15);opacity:0;visibility:hidden;transform:translateY(-10px);transition:all 0.2s;z-index:1000}
        .menu-dropdown.active{opacity:1;visibility:visible;transform:translateY(0)}
        .menu-item{display:flex;align-items:center;gap:10px;padding:11px 12px;border-radius:8px;cursor:pointer;color:#1e293b;font-size:0.88em;font-weight:500;white-space:nowrap}
        .menu-item:active{background:#f1f5f9}
        .menu-item.danger{color:#dc2626}
        .menu-divider{height:1px;background:#e2e8f0;margin:6px 0}
        .menu-user{padding:10px 12px;border-bottom:1px solid #e2e8f0;margin-bottom:6px}
        .menu-user-name{font-weight:600;color:#1e293b;font-size:0.9em}
        .menu-user-email{color:#64748b;font-size:0.7em;margin-top:2px}

        /* â•â•â• Cards â•â•â• */
        .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px}
        .card{background:white;border:1px solid #e2e8f0;border-radius:10px;padding:12px}
        .card.main-card{grid-column:span 2;background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%);border:2px solid #16a34a}
        .card.main-card.negative{background:linear-gradient(135deg,#fef2f2 0%,#fee2e2 100%);border-color:#dc2626}
        .card-title{color:#64748b;font-size:0.7em;font-weight:600;text-transform:uppercase;margin-bottom:4px}
        .card-value{font-size:1.4em;font-weight:bold}
        .card-subtitle{color:#94a3b8;font-size:0.65em;margin-top:2px}
        .positive{color:#16a34a}.negative{color:#dc2626}.info{color:#0284c7}
        .stats-row{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
        .stat-badge{font-size:0.6em;background:#f1f5f9;padding:2px 6px;border-radius:4px;color:#64748b}

        /* â•â•â• Section â•â•â• */
        .section-title{color:#1e293b;font-size:1em;font-weight:600;margin-bottom:12px}

        /* â•â•â• Bancos Grid â•â•â• */
        .bancos-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:20px}
        .banco-mini-card{background:white;border:1px solid #e2e8f0;border-radius:8px;padding:10px;cursor:pointer}
        .banco-nombre{font-weight:600;color:#1e293b;font-size:0.8em;margin-bottom:2px}
        .banco-saldo{font-size:1.1em;font-weight:bold;color:#16a34a}
        .banco-moneda{font-size:0.65em;color:#94a3b8}
        .banco-limite{font-size:0.6em;color:#64748b;margin-top:2px}
        .banco-limite-bar{height:4px;background:#e2e8f0;border-radius:2px;margin-top:3px;overflow:hidden}
        .banco-limite-fill{height:100%;background:#3b82f6;border-radius:2px;transition:width 0.3s}
        .banco-limite-fill.warning{background:#f59e0b}
        .banco-limite-fill.danger{background:#dc2626}
        .usdt-card{background:linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%);border-color:#93c5fd}
        .usdt-card .banco-saldo{color:#2563eb}

        /* â•â•â• Toggle Sections â•â•â• */
        .toggle-section{background:white;border:1px solid #e2e8f0;border-radius:10px;margin-bottom:15px;overflow:hidden}
        .toggle-header{display:flex;justify-content:space-between;align-items:center;padding:14px 15px;cursor:pointer;user-select:none}
        .toggle-header:active{background:#f8fafc}
        .toggle-title{font-size:0.95em;font-weight:600;color:#1e293b;display:flex;align-items:center;gap:8px}
        .toggle-right{display:flex;align-items:center;gap:10px}
        .toggle-badge{background:#e2e8f0;color:#64748b;font-size:0.75em;padding:2px 8px;border-radius:10px;font-weight:500}
        .toggle-arrow{font-size:0.8em;color:#94a3b8;transition:transform 0.2s}
        .toggle-section.open .toggle-arrow{transform:rotate(180deg)}
        .toggle-content{display:none;border-top:1px solid #e2e8f0}
        .toggle-section.open .toggle-content{display:block}

        /* â•â•â• Forms â•â•â• */
        .form-content{padding:15px}
        .form-group{margin-bottom:12px}
        .form-group label{display:block;color:#64748b;font-size:0.75em;margin-bottom:4px;font-weight:500}
        .form-group input,.form-group select,.form-group textarea{width:100%;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;color:#1e293b;font-size:16px;font-family:inherit;max-width:100%}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:#2563eb}
        .form-group input.error,.form-group select.error{border-color:#dc2626;background:#fef2f2}
        .form-group small{display:block;color:#94a3b8;font-size:0.7em;margin-top:3px}
        .form-group small.error-text{color:#dc2626}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        #tipo{font-weight:700}
        #tipo option[value="compra"]{color:#16a34a;font-weight:700}
        #tipo option[value="venta"]{color:#dc2626;font-weight:700}
        #banco{font-weight:600}

        /* â•â•â• Buttons â•â•â• */
        .btn{background:#2563eb;color:white;border:none;padding:14px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-size:0.95em;width:100%}
        .btn:active{background:#1d4ed8}
        .btn:disabled{background:#94a3b8;cursor:not-allowed}
        .btn-delete{background:transparent;color:#ef4444;border:none;cursor:pointer;font-size:1.1em;padding:4px 8px}
        .btn-cancel{background:#e5e7eb;color:#4b5563}
        .btn-edit-small{padding:5px 10px;font-size:0.7em;background:#3b82f6;color:white;border:none;border-radius:5px;cursor:pointer}
        .info-text{color:#64748b;font-size:0.75em;margin-top:10px}
        .preview-box{background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:10px;margin-bottom:12px;color:#1e40af;font-size:0.85em}

        /* â•â•â• Tables â•â•â• */
        .table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
        table{width:100%;border-collapse:collapse;min-width:620px}
        th{background:#f8fafc;color:#64748b;font-size:0.68em;font-weight:600;padding:10px 8px;text-align:left;text-transform:uppercase}
        td{padding:10px 8px;color:#1e293b;border-top:1px solid #f1f5f9;font-size:0.8em}

        /* â•â•â• Badges â•â•â• */
        .badge{display:inline-block;padding:3px 8px;border-radius:12px;font-size:0.68em;font-weight:700}
        .badge-compra{background:#dcfce7;color:#16a34a}
        .badge-venta{background:#fee2e2;color:#dc2626}
        .badge-ingreso{background:#dcfce7;color:#16a34a}
        .badge-egreso{background:#fee2e2;color:#dc2626}
        .text-compra{color:#16a34a;font-weight:700}
        .text-venta{color:#dc2626;font-weight:700}
        .fecha-hora{display:flex;flex-direction:column;gap:1px}
        .fecha-hora .fecha{color:#1e293b;font-weight:500}
        .fecha-hora .hora{color:#94a3b8;font-size:0.85em}

        /* â•â•â• Empty & Pagination â•â•â• */
        .empty-state{text-align:center;padding:30px;color:#94a3b8}
        .empty-state-icon{font-size:2em;margin-bottom:8px}
        .pagination{display:flex;justify-content:center;align-items:center;gap:8px;padding:12px;border-top:1px solid #e2e8f0}
        .pagination button{background:#f1f5f9;border:none;padding:8px 14px;border-radius:6px;font-size:0.85em;cursor:pointer;color:#475569}
        .pagination button:disabled{opacity:0.4;cursor:not-allowed}
        .pagination-info{font-size:0.8em;color:#64748b}

        /* â•â•â• Modals â•â•â• */
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;padding:15px}
        .modal.active{display:flex}
        .modal-content{background:white;border-radius:14px;padding:20px;max-width:420px;width:100%;max-height:85vh;overflow-y:auto}
        .modal-header{font-size:1.2em;font-weight:bold;color:#1e293b;margin-bottom:15px}
        .modal-buttons{display:flex;gap:10px;margin-top:18px}
        .modal-buttons .btn{flex:1}

        /* â•â•â• Banco List â•â•â• */
        .banco-list-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:8px;background:#f8fafc}
        .banco-list-actions{display:flex;gap:8px;align-items:center}
        .toggle-switch{position:relative;width:44px;height:24px}
        .toggle-switch input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#cbd5e1;transition:.3s;border-radius:24px}
        .toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.3s;border-radius:50%}
        .toggle-switch input:checked+.toggle-slider{background-color:#16a34a}
        .toggle-switch input:checked+.toggle-slider:before{transform:translateX(20px)}

        /* â•â•â• Tabs â•â•â• */
        .tabs{display:flex;gap:5px;margin-bottom:12px}
        .tab{padding:10px 14px;border-radius:8px;cursor:pointer;font-size:0.85em;font-weight:600;border:2px solid #e2e8f0;flex:1;text-align:center;transition:all 0.2s}
        .tab-ingreso{background:#f8fafc;color:#16a34a;border-color:#e2e8f0}
        .tab-ingreso:hover{background:#f0fdf4;border-color:#86efac}
        .tab-ingreso.active{background:#16a34a;color:white;border-color:#16a34a}
        .tab-egreso{background:#f8fafc;color:#dc2626;border-color:#e2e8f0}
        .tab-egreso:hover{background:#fef2f2;border-color:#fca5a5}
        .tab-egreso.active{background:#dc2626;color:white;border-color:#dc2626}

        /* â•â•â• ComisiÃ³n â•â•â• */
        .comision-inline{display:flex;align-items:center;gap:6px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:8px 12px;margin-top:8px}
        .comision-inline label{color:#64748b;font-size:0.75em;font-weight:500;white-space:nowrap}
        .comision-inline input{width:60px;background:white;border:1px solid #e2e8f0;border-radius:6px;padding:8px;color:#1e293b;font-size:16px;text-align:center}
        .comision-inline input:focus{outline:none;border-color:#2563eb}
        .comision-inline span{color:#64748b;font-weight:500}

        /* â•â•â• Overlays â•â•â• */
        .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.95);display:flex;align-items:center;justify-content:center;z-index:2000;flex-direction:column;gap:12px}
        .loading-overlay.hidden{display:none}
        .spinner{width:36px;height:36px;border:3px solid #e2e8f0;border-top-color:#2563eb;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .cooldown-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);z-index:1500;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px}
        .cooldown-overlay.hidden{display:none}
        .cooldown-text{color:#1e293b;font-weight:600;font-size:1.1em}

        /* â•â•â• Auth â•â•â• */
        .auth-container{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
        .auth-box{background:white;border-radius:16px;padding:30px 20px;max-width:360px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.1)}
        .auth-logo{text-align:center;font-size:2.5em;margin-bottom:8px}
        .auth-title{text-align:center;color:#1e293b;font-size:1.3em;margin-bottom:6px}
        .auth-subtitle{text-align:center;color:#64748b;font-size:0.85em;margin-bottom:25px}
        .auth-tabs{display:flex;margin-bottom:20px;border-radius:10px;background:#f1f5f9;padding:4px}
        .auth-tab{flex:1;padding:10px;text-align:center;border-radius:8px;cursor:pointer;font-weight:500;color:#64748b;border:none;background:transparent;font-size:0.9em}
        .auth-tab.active{background:white;color:#1e293b;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
        .auth-error{background:#fee2e2;color:#dc2626;padding:10px;border-radius:8px;margin-bottom:14px;font-size:0.85em;display:none}
        .auth-error.show{display:block}
        .app-container{display:none}
        .app-container.active{display:block}
        .auth-container.hidden{display:none}

        /* â•â•â• Calendar â•â•â• */
        .calendar-container{background:#1a1a2e;border-radius:12px;padding:15px}
        .calendar-header{display:flex;justify-content:center;align-items:center;gap:15px;margin-bottom:15px}
        .calendar-header button{background:none;border:none;color:white;font-size:1.2em;cursor:pointer;padding:5px 10px}
        .calendar-month{color:white;font-size:1.1em;font-weight:600;min-width:100px;text-align:center}
        .calendar-weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:8px}
        .calendar-weekday{color:#64748b;font-size:0.7em;text-align:center;font-weight:600}
        .calendar-days{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
        .calendar-day{aspect-ratio:1;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:0.8em;color:white;background:#2d2d44;min-height:42px}
        .calendar-day.empty{background:transparent}
        .calendar-day.positive{background:linear-gradient(135deg,#064e3b 0%,#065f46 100%)}
        .calendar-day.negative{background:linear-gradient(135deg,#7f1d1d 0%,#991b1b 100%)}
        .calendar-day.today{box-shadow:0 0 0 2px #3b82f6}
        .calendar-day-number{font-weight:600;font-size:0.95em}
        .calendar-day-value{font-size:0.6em;margin-top:1px}
        .calendar-day-value.pos{color:#4ade80}
        .calendar-day-value.neg{color:#f87171}
        .calendar-summary{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:12px}
        .calendar-stat{background:#2d2d44;border-radius:8px;padding:10px;text-align:center}
        .calendar-stat.full{grid-column:span 2}
        .calendar-stat-value{color:white;font-size:1.1em;font-weight:bold}
        .calendar-stat-label{color:#64748b;font-size:0.65em;margin-top:2px}

        /* â•â•â• Responsive â•â•â• */
        @media(min-width:640px){.cards{grid-template-columns:repeat(3,1fr)}.card.main-card{grid-column:span 1}.bancos-grid{grid-template-columns:repeat(3,1fr)}}
        @media(min-width:1024px){.cards{grid-template-columns:repeat(6,1fr)}.bancos-grid{grid-template-columns:repeat(6,1fr)}}

        /* â•â•â• Tags â•â•â• */
        .tags-container{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;min-height:0}
        .tags-container:empty{display:none}
        .tag-chip,.tag-pill{display:inline-flex;align-items:center;gap:4px;padding:5px 11px;border-radius:14px;font-size:0.76em;background:#f1f5f9;color:#475569;border:1px solid #e2e8f0;cursor:pointer;transition:all 0.15s;user-select:none;white-space:nowrap}
        .tag-chip:hover,.tag-pill:hover{background:#dbeafe;border-color:#93c5fd;color:#1d4ed8}
        .tag-chip:active,.tag-pill:active{background:#bfdbfe}
        .tag-sugerencias{margin-top:6px}
        .tag-sugerencias-label{font-size:0.7em;color:#94a3b8;margin-bottom:4px;font-weight:500}
        .tag-manage-item{display:flex;justify-content:space-between;align-items:center;padding:9px 10px;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:6px;background:#f8fafc;gap:8px}
        .tag-name{font-size:0.88em;color:#1e293b;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .tag-count{font-size:0.7em;color:#94a3b8;margin-right:4px}
        .tag-actions{display:flex;gap:6px;flex-shrink:0}
        .tag-edit-btn,.tag-delete-btn{padding:4px 8px;font-size:0.8em;background:transparent;border:none;cursor:pointer;border-radius:4px}
        .tag-edit-btn:hover{background:#dbeafe}
        .tag-delete-btn:hover{background:#fee2e2}
        .tag-search{width:100%;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px;color:#1e293b;font-size:0.88em;margin-bottom:10px;font-family:inherit}
        .tag-search:focus{outline:none;border-color:#2563eb}
    </style>
</head>
<body>
    <!-- â•â•â• OVERLAYS â•â•â• -->
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div><div style="color:#64748b;font-size:0.9em">Cargando...</div></div>
    <div class="cooldown-overlay hidden" id="cooldownOverlay"><div class="spinner"></div><div class="cooldown-text">Guardado âœ“</div></div>

    <!-- â•â•â• AUTH â•â•â• -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-logo">ğŸ’±</div>
            <h1 class="auth-title">Registro P2P</h1>
            <p class="auth-subtitle">Control de operaciones y saldos</p>
            <div class="auth-tabs">
                <button class="auth-tab active" id="tabLogin">Iniciar SesiÃ³n</button>
                <button class="auth-tab" id="tabRegister">Registrarse</button>
            </div>
            <div class="auth-error" id="authError"></div>
            <form class="auth-form" id="loginForm">
                <div class="form-group"><label>Usuario</label><input type="text" id="loginUser" placeholder="Tu usuario" required></div>
                <div class="form-group"><label>ContraseÃ±a</label><input type="password" id="loginPass" placeholder="Tu contraseÃ±a" required></div>
                <button type="submit" class="btn" id="loginBtn">Iniciar SesiÃ³n</button>
            </form>
            <form class="auth-form" id="registerForm" style="display:none">
                <div class="form-group"><label>Usuario</label><input type="text" id="regUser" placeholder="Elige un usuario" required><small>Letras, nÃºmeros, guiones. 3-20 caracteres.</small></div>
                <div class="form-group"><label>ContraseÃ±a</label><input type="password" id="regPass" placeholder="Crea una contraseÃ±a" required><small>MÃ­nimo 6 caracteres</small></div>
                <div class="form-group"><label>Confirmar ContraseÃ±a</label><input type="password" id="regPassConfirm" placeholder="Repite la contraseÃ±a" required></div>
                <button type="submit" class="btn" id="registerBtn">Crear Cuenta</button>
            </form>
        </div>
    </div>

    <!-- â•â•â• APP â•â•â• -->
    <div class="app-container" id="appContainer">
        <div class="container">
            <div class="header">
                <h1>ğŸ’± Registro P2P</h1>
                <p>Control de operaciones y saldos</p>
                <div class="sync-status offline" id="syncStatus"><div class="sync-dot"></div><span id="syncText">...</span></div>
                <div class="menu-container">
                    <button class="menu-btn" id="menuBtn"><span></span><span></span><span></span></button>
                    <div class="menu-dropdown" id="menuDropdown">
                        <div class="menu-user"><div class="menu-user-name" id="menuUserName">Usuario</div><div class="menu-user-email" id="menuUserEmail">@p2p</div></div>
                        <div class="menu-item" data-action="calendario"><span>ğŸ“…</span><span>Calendario</span></div>
                        <div class="menu-item" data-action="inventario"><span>ğŸ“¦</span><span>Inventario USDT</span></div>
                        <div class="menu-item" data-action="movimiento"><span>ğŸ’¸</span><span>Movimiento Externo</span></div>
                        <div class="menu-item" data-action="bancos"><span>ğŸ¦</span><span>Gestionar Bancos</span></div>
                        <div class="menu-item" data-action="transferencia"><span>â†”ï¸</span><span>Transferencia</span></div>
                        <div class="menu-item" data-action="gestion-tags"><span>ğŸ·ï¸</span><span>GestiÃ³n de Tags</span></div>
                        <div class="menu-divider"></div>
                        <div class="menu-item danger" data-action="borrar-todo"><span>ğŸ—‘ï¸</span><span>Borrar Todo</span></div>
                        <div class="menu-divider"></div>
                        <div class="menu-item" data-action="cerrar-sesion"><span>ğŸšª</span><span>Cerrar SesiÃ³n</span></div>
                    </div>
                </div>
            </div>

            <div class="cards">
                <div class="card main-card" id="cardGananciaHoy"><div class="card-title">ğŸ“ˆ Ganancia Hoy</div><div class="card-value positive" id="gananciaHoy">$0</div><div class="card-subtitle" id="fechaHoy">--</div><div class="stats-row"><span class="stat-badge" id="opsHoy">0 ops</span></div></div>
                <div class="card" id="cardGananciaUSD" style="display:none;background:linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%);border:2px solid #3b82f6"><div class="card-title">ğŸ’µ Ganancia Hoy USD</div><div class="card-value positive" id="gananciaHoyUSD">US$0</div><div class="card-subtitle" id="opsHoyUSD">0 ops USD</div></div>
                <div class="card"><div class="card-title">ğŸ“¦ <b style="color:#1e293b">USDT</b></div><div class="card-value info" id="usdtEnTenencia">0,00</div><div class="card-subtitle">En tenencia</div></div>
                <div class="card"><div class="card-title">ğŸ¦ Bancos</div><div class="card-value positive" id="totalBancos">$0</div><div class="card-subtitle">Saldo UYU</div></div>
                <div class="card"><div class="card-title">ğŸ“¥ <span class="text-compra">Compras</span> <span id="mesCompras" style="color:#94a3b8;font-weight:400;text-transform:none"></span></div><div class="card-value" style="font-size:1.2em" id="totalPagado">$0</div><div class="stats-row"><span class="stat-badge" id="tasaPromCompra">--</span><span class="stat-badge" id="loteMasBarato">--</span></div></div>
                <div class="card"><div class="card-title">ğŸ“¤ <span class="text-venta">Ventas</span> <span id="mesVentas" style="color:#94a3b8;font-weight:400;text-transform:none"></span></div><div class="card-value" style="font-size:1.2em" id="totalRecibido">$0</div><div class="stats-row"><span class="stat-badge" id="tasaPromVenta">--</span><span class="stat-badge" id="lotesDisponibles">--</span></div></div>
                <div class="card"><div class="card-title">ğŸ“Š Spread</div><div class="card-value info" id="spreadPromedio">$0</div><div class="stats-row"><span class="stat-badge" id="porcentajeSpread">0%</span></div></div>
            </div>

            <div class="section-title">ğŸ’¼ Mis Saldos</div>
            <div class="bancos-grid" id="bancosGrid"></div>

            <!-- Nueva OperaciÃ³n -->
            <div class="toggle-section open" id="seccionNuevaOp">
                <div class="toggle-header"><span class="toggle-title">â• Nueva OperaciÃ³n</span><span class="toggle-arrow">â–¼</span></div>
                <div class="toggle-content">
                    <div class="form-content">
                        <div class="form-group"><label>Tipo de operaciÃ³n</label><select id="tipo"><option value="compra">ğŸ›’ Compra USDT</option><option value="venta">ğŸ’µ Venta USDT</option></select></div>
                        <div class="form-row">
                            <div class="form-group"><label id="montoLabel">Monto (UYU)</label><input type="number" step="0.01" id="monto" placeholder="3900"></div>
                            <div class="form-group"><label>Tasa *</label><input type="text" id="tasa" placeholder="39.50" inputmode="decimal"><small id="tasaHelp">Ej: 39.50</small></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label id="bancoLabel">Banco *</label><select id="banco"><option value="">-- Seleccionar --</option></select><small id="bancoHelp"></small></div>
                            <div class="form-group" id="comisionBancoGroup"><label>ComisiÃ³n banco</label><input type="number" step="0.01" id="comisionBanco" value="0" placeholder="0"></div>
                        </div>
                        <div class="comision-inline"><label>ğŸ“Š ComisiÃ³n Binance:</label><input type="text" id="comisionPlataforma" value="0.14" placeholder="0.14" inputmode="decimal"><span>%</span></div>
                        <div class="preview-box" id="previewBox" style="display:none"><span id="previewText"></span></div>
                        <button class="btn" id="btnAgregarOp" style="margin-top:12px">Agregar OperaciÃ³n</button>
                        <div class="info-text">ComisiÃ³n <span id="comisionPctLabel">0.14</span>%: <strong id="comisionPlataformaInfo">0 USDT</strong> <span id="saldoBancoInfo"></span></div>
                    </div>
                </div>
            </div>

            <!-- Operaciones -->
            <div class="toggle-section open" id="seccionOperaciones">
                <div class="toggle-header"><span class="toggle-title">ğŸ“‹ Operaciones</span><div class="toggle-right"><span class="toggle-badge" id="totalOperaciones">0</span><span class="toggle-arrow">â–¼</span></div></div>
                <div class="toggle-content">
                    <div class="table-scroll" id="tablaContent"><div class="empty-state"><div class="empty-state-icon">ğŸ“</div><div>Sin operaciones</div></div></div>
                    <div class="pagination" id="paginationOp" style="display:none"><button id="btnPrevOp">â† Ant</button><span class="pagination-info" id="paginaInfoOp">1 / 1</span><button id="btnNextOp">Sig â†’</button></div>
                </div>
            </div>

            <!-- Movimientos -->
            <div class="toggle-section" id="seccionMovimientos" style="display:none">
                <div class="toggle-header"><span class="toggle-title">ğŸ’¸ Movimientos</span><div class="toggle-right"><span class="toggle-badge" id="totalMovimientos">0</span><span class="toggle-arrow">â–¼</span></div></div>
                <div class="toggle-content">
                    <div class="table-scroll" id="movimientosContent"></div>
                    <div class="pagination" id="paginationMov" style="display:none"><button id="btnPrevMov">â† Ant</button><span class="pagination-info" id="paginaInfoMov">1 / 1</span><button id="btnNextMov">Sig â†’</button></div>
                </div>
            </div>

            <!-- Transferencias -->
            <div class="toggle-section" id="seccionTransferencias" style="display:none">
                <div class="toggle-header"><span class="toggle-title">â†”ï¸ Transferencias</span><div class="toggle-right"><span class="toggle-badge" id="totalTransferencias">0</span><span class="toggle-arrow">â–¼</span></div></div>
                <div class="toggle-content">
                    <div class="table-scroll" id="transferenciasContent"></div>
                    <div class="pagination" id="paginationTrans" style="display:none"><button id="btnPrevTrans">â† Ant</button><span class="pagination-info" id="paginaInfoTrans">1 / 1</span><button id="btnNextTrans">Sig â†’</button></div>
                </div>
            </div>

            <!-- Conversiones -->
            <div class="toggle-section" id="seccionConversiones" style="display:none">
                <div class="toggle-header"><span class="toggle-title">ğŸ’± Conversiones</span><div class="toggle-right"><span class="toggle-badge" id="totalConversiones">0</span><span class="toggle-arrow">â–¼</span></div></div>
                <div class="toggle-content">
                    <div class="table-scroll" id="conversionesContent"></div>
                    <div class="pagination" id="paginationConv" style="display:none"><button id="btnPrevConv">â† Ant</button><span class="pagination-info" id="paginaInfoConv">1 / 1</span><button id="btnNextConv">Sig â†’</button></div>
                </div>
            </div>
        </div>
    </div>

    <!-- â•â•â• MODALS â•â•â• -->
    <div id="modalCalendario" class="modal"><div class="modal-content" style="max-width:420px;padding:15px"><div class="calendar-container"><div class="calendar-header"><button id="btnCalPrev">â—€</button><div class="calendar-month" id="calendarMonth">2025-01</div><button id="btnCalNext">â–¶</button></div><div class="calendar-weekdays"><div class="calendar-weekday">D</div><div class="calendar-weekday">L</div><div class="calendar-weekday">M</div><div class="calendar-weekday">M</div><div class="calendar-weekday">J</div><div class="calendar-weekday">V</div><div class="calendar-weekday">S</div></div><div class="calendar-days" id="calendarDays"></div><div class="calendar-summary"><div class="calendar-stat full" id="calGananciaTotalBox"><div class="calendar-stat-value positive" id="calGananciaTotal">$0</div><div class="calendar-stat-label">ğŸ’° Ganancia Total (UYU)</div></div><div class="calendar-stat" id="calGananciaUSDBox" style="display:none"><div class="calendar-stat-value positive" id="calGananciaUSD">US$0</div><div class="calendar-stat-label">ğŸ’µ Ganancia Total (USD)</div></div><div class="calendar-stat"><div class="calendar-stat-value positive" id="calGanancias">$0</div><div class="calendar-stat-label">Mes +</div></div><div class="calendar-stat"><div class="calendar-stat-value negative" id="calPerdidas">$0</div><div class="calendar-stat-label">Mes -</div></div></div></div><div class="modal-buttons"><button class="btn" id="btnCerrarCalendario">Cerrar</button></div></div></div>
    <div id="modalMovimiento" class="modal"><div class="modal-content"><div class="modal-header">ğŸ’¸ Movimiento Externo</div><div class="tabs"><button class="tab tab-ingreso active" id="tabIngreso">ğŸ“¥ Ingreso</button><button class="tab tab-egreso" id="tabEgreso">ğŸ“¤ Egreso</button></div><div class="form-group"><label>Tipo de cuenta</label><select id="movTipoCuenta"><option value="banco">ğŸ¦ Banco</option><option value="usdt">ğŸª™ USDT</option></select></div><div class="form-group" id="movBancoGroup"><label>Banco</label><select id="movBanco"></select></div><div class="form-group" id="movTasaRefGroup" style="display:none"><label id="movTasaRefLabel">Tasa referencia ($/USDT)</label><input type="number" step="0.01" id="movTasaRef"><small>Precio al que se registra en el inventario FIFO</small></div><div class="form-group"><label id="movMontoLabel">Monto</label><input type="number" step="0.01" id="movMonto"></div><div id="movFifoPreview" style="display:none;background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:10px;margin-bottom:12px"></div><div class="form-group"><label>DescripciÃ³n (opcional)</label><textarea id="movDescripcion" rows="2"></textarea><div id="tagSugerenciasMov"></div></div><div class="modal-buttons"><button class="btn btn-cancel" id="btnCancelMov">Cancelar</button><button class="btn" id="btnGuardarMov">Guardar</button></div></div></div>
    <div id="modalBancos" class="modal"><div class="modal-content"><div class="modal-header">ğŸ¦ Gestionar Bancos</div><div id="listaBancos"></div><div class="modal-buttons"><button class="btn" id="btnCerrarBancos">Cerrar</button></div></div></div>
    <div id="modalTransferencia" class="modal"><div class="modal-content"><div class="modal-header" id="transfHeader">â†”ï¸ Transferencia entre Bancos</div><div class="form-group"><label>Banco origen</label><select id="bancoOrigen"></select><small id="saldoOrigenInfo"></small></div><div class="form-group"><label>Banco destino</label><select id="bancoDestino"></select></div><div id="transfTasaGroup" class="form-group" style="display:none"><label>Tasa de conversiÃ³n (UYU por 1 USD)</label><input type="number" step="0.01" id="transfTasa" placeholder="Ej: 42.50"></div><div class="form-group"><label>Monto</label><input type="number" step="0.01" id="montoTransferencia"></div><div id="transfConvPreview" style="display:none;background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:10px;margin-bottom:12px;font-size:0.85em;color:#1e40af"></div><div class="form-group"><label>ComisiÃ³n (opcional)</label><input type="number" step="0.01" id="comisionTransferencia" value="0"></div><div class="modal-buttons"><button class="btn btn-cancel" id="btnCancelTransf">Cancelar</button><button class="btn" id="btnTransferir">Transferir</button></div></div></div>
    <div id="modalEditarSaldo" class="modal"><div class="modal-content"><div class="modal-header" id="editarSaldoHeader">Editar Saldo</div><div class="form-group"><label>Nuevo saldo</label><input type="number" step="0.01" id="nuevoSaldoBanco"></div><div class="form-group" id="limiteDiarioGroup"><label>LÃ­mite diario (USD)</label><input type="number" step="1" id="limiteDiarioBanco" placeholder="0 = sin lÃ­mite"><small>Se descuenta automÃ¡ticamente con cada compra</small></div><div class="modal-buttons"><button class="btn btn-cancel" id="btnCancelSaldo">Cancelar</button><button class="btn" id="btnGuardarSaldo">Guardar</button></div></div></div>
    <div id="modalInventario" class="modal"><div class="modal-content"><div class="modal-header">ğŸ“¦ Inventario USDT (FIFO)</div><div id="inventarioContent" style="max-height:50vh;overflow-y:auto"></div><div style="background:#f1f5f9;padding:10px;border-radius:8px;margin-top:12px"><div style="font-size:0.75em;color:#64748b">Sistema FIFO: Al vender se consumen primero los lotes mÃ¡s antiguos</div></div><div class="modal-buttons"><button class="btn" style="background:#16a34a" id="btnAgregarLote">+ Agregar</button><button class="btn btn-cancel" id="btnRecalcular">ğŸ”„ Recalcular</button><button class="btn" id="btnCerrarInventario">Cerrar</button></div></div></div>
    <div id="modalEditarLote" class="modal"><div class="modal-content"><div class="modal-header" id="editarLoteHeader">Editar Lote</div><div class="form-group"><label>Precio de compra (tasa)</label><input type="number" step="0.01" id="lotePrecio" placeholder="Ej: 42.50"></div><div class="form-group"><label>Cantidad disponible (USDT)</label><input type="number" step="0.01" id="loteDisponible" placeholder="Ej: 100.00"></div><div class="form-group"><label>Fecha (opcional)</label><input type="date" id="loteFecha"></div><div class="modal-buttons"><button class="btn btn-cancel" id="btnCancelLote">Cancelar</button><button class="btn" style="background:#dc2626" id="btnEliminarLote">Eliminar</button><button class="btn" id="btnGuardarLote">Guardar</button></div></div></div>
    <div id="modalGestionTags" class="modal"><div class="modal-content"><div class="modal-header">ğŸ·ï¸ GestiÃ³n de Tags</div><input class="tag-search" type="text" id="tagSearch" placeholder="ğŸ” Buscar etiqueta..."><div id="tagsList" style="max-height:50vh;overflow-y:auto"></div><div style="background:#f1f5f9;padding:10px;border-radius:8px;margin-top:12px"><div style="font-size:0.75em;color:#64748b">Las etiquetas se crean automÃ¡ticamente al guardar movimientos con descripciÃ³n</div></div><div class="modal-buttons"><button class="btn" id="btnCerrarTags">Cerrar</button></div></div></div>

    <!-- â•â•â• FIREBASE SDK â•â•â• -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  REGISTRO P2P â€” CÃ³digo refactorizado                     â•‘
   â•‘  â€¢ Estado centralizado (AppState)                        â•‘
   â•‘  â€¢ Sin eventos inline (event delegation)                 â•‘
   â•‘  â€¢ Funciones de DOM centralizadas                        â•‘
   â•‘  â€¢ PaginaciÃ³n genÃ©rica reutilizable                      â•‘
   â•‘  â€¢ FIFO encapsulado                                      â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Â§1 â€” CONFIGURACIÃ“N
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CONFIG = {
    firebase: {apiKey:"AIzaSyCL2uxQMNIxC0oo35uN-lYQXaOWLxXNg7k",authDomain:"p2p-tracker-dc9cc.firebaseapp.com",projectId:"p2p-tracker-dc9cc",storageBucket:"p2p-tracker-dc9cc.firebasestorage.app",messagingSenderId:"670856094446",appId:"1:670856094446:web:390946887212a97e36c9ff"},
    POR_PAGINA: 10,
    EMAIL_DOMAIN: '@p2p-tracker.app',
    COOLDOWN_MS: 1000,
    BANCOS: [
        {nombre:'Santander',moneda:'UYU',color:'#ec0000'},
        {nombre:'BBVA',moneda:'UYU',color:'#004481'},
        {nombre:'Itau',moneda:'UYU',especial:'itau',color:'#ef6c00'},
        {nombre:'Scotiabank',moneda:'UYU',color:'#ec111a'},
        {nombre:'BROU',moneda:'UYU',color:'#003087'},
        {nombre:'Prex',moneda:'UYU',color:'#6d28d9'},
        {nombre:'OCA',moneda:'UYU',color:'#005baa'},
        {nombre:'Mercado Pago',moneda:'UYU',color:'#009ee3'},
        {nombre:'Midinero',moneda:'UYU',color:'#00b460'},
        {nombre:'Zelle',moneda:'USD',color:'#6c1cd3'},
        {nombre:'Zinli',moneda:'USD',color:'#00c28e'},
        {nombre:'Skrill',moneda:'USD',color:'#862165'}
    ]
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Â§2 â€” ESTADO CENTRALIZADO
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const AppState = {
    db: null, auth: null, currentUser: null, unsubscribe: null,
    datos: null,
    ui: { bancoEditando:null, tipoMovimiento:'ingreso', calendarDate:new Date(),
          loteEditandoId:null, paginaOp:1, paginaMov:1, paginaTrans:1, paginaConv:1,
          guardandoMovimiento:false, guardandoLote:false, guardandoOperacion:false, guardandoTransferencia:false,
          enCooldown:false, comisionDebounce:null, tasaManual:false, ultimoMonedaBanco:null }
};

function crearDatosVacios() {
    return {operaciones:[],movimientos:[],transferencias:[],conversiones:[],bancos:{},lotes:[],tags:[],
            saldoUsdt:0,ultimaTasaCompra:0,ultimaTasaVenta:0,comisionPlataforma:0.14,
            ultimaTasaCompraUSD:0,ultimaTasaVentaUSD:0,comisionUSD:0.14};
}
AppState.datos = crearDatosVacios();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Â§3 â€” HELPERS DOM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const $ = id => document.getElementById(id);
const setText = (id, t) => { const e=$(id); if(e) e.textContent=t; };
const setHtml = (id, h) => { const e=$(id); if(e) e.innerHTML=h; };

function abrirModal(id) { $(id)?.classList.add('active'); }
function cerrarModal(id) { $(id)?.classList.remove('active'); }
function setSyncStatus(s,t) { $('syncStatus').className='sync-status '+s; setText('syncText',t); }
function ocultarLoading() { $('loadingOverlay')?.classList.add('hidden'); }
function activarCooldown() {
    AppState.ui.enCooldown=true; $('cooldownOverlay')?.classList.remove('hidden');
    setTimeout(()=>{ AppState.ui.enCooldown=false; $('cooldownOverlay')?.classList.add('hidden'); },CONFIG.COOLDOWN_MS);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Â§4 â€” UTILIDADES PURAS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fixNeg(n){if(Object.is(n,-0))return 0;const r=Number(Math.round(parseFloat(n+'e2'))+'e-2');return isNaN(r)?0:r}
function truncar(n,d=2){if(isNaN(n)||!isFinite(n))return 0;const f=Number(n+'e'+d);return Number(Math.floor(f)+'e-'+d)}
function roundMoney(n,d=2){if(isNaN(n)||!isFinite(n))return 0;const r=Number(Math.round(parseFloat(n+'e'+d))+'e-'+d);return Object.is(r,-0)?0:r}
/* Binance-matching: redondear USDT a 2dp (Binance usa round, no floor) */
function truncUsdt(n){return roundMoney(n,2)}
function fmtNum(n,d=2){return n.toLocaleString('es-UY',{minimumFractionDigits:d,maximumFractionDigits:d})}
/* Formatear con redondeo (Binance-matching) â€” para mostrar USDT igual que Binance */
function fmtTrunc(n,d=2){const t=roundMoney(n,d);return t.toLocaleString('es-UY',{minimumFractionDigits:d,maximumFractionDigits:d})}
function fmtTasa(n,mon){if(mon==='USD'){const s=n.toString(),dec=s.includes('.')?s.split('.')[1].length:0;return dec>2?n.toFixed(3):n.toFixed(2)}return n.toFixed(2)}
function parsearTasa(v){if(!v)return null;const l=v.toString().replace(',','.').trim();if(!/^\d+(\.\d{1,3})?$/.test(l))return null;const n=parseFloat(l);return isNaN(n)||n<=0?null:n}
function parsearComision(v){if(!v&&v!==0)return null;const l=v.toString().replace(',','.').trim();if(!l||l==='.')return null;if(!/^\d*\.?\d*$/.test(l))return null;const n=parseFloat(l);return isNaN(n)||n<0||n>10?null:n}
function getUDate(){const n=new Date(),u=n.getTime()+n.getTimezoneOffset()*60000;return new Date(u-3*3600000)}
function getUDateStr(){const d=getUDate();return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function getUTimeStr(){const d=getUDate();return`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`}
function fmtFechaCorta(f){if(!f)return'-';const p=f.split('-');return p.length===3?`${p[2]}/${p[1]}`:f}
function fechaHtml(f,h){return`<div class="fecha-hora"><span class="fecha">${fmtFechaCorta(f)}</span><span class="hora">${h||'--:--'}</span></div>`}
function getBancoInfo(n){return CONFIG.BANCOS.find(b=>b.nombre===n)}
function getBancoColor(n){const b=getBancoInfo(n);return b?.color||'#1e293b'}
function colorBanco(n){return`<span style="color:${getBancoColor(n)};font-weight:600">${n}</span>`}
function getSym(mon){return mon==='USD'?'US$':'$'}
function sincronizarSaldoUsdt(){AppState.datos.saldoUsdt=truncUsdt(AppState.datos.lotes.reduce((s,l)=>s+l.disponible,0))}

/* â•â•â• Tags â•â•â• */
function normalizarTag(t){return(t||'').trim().replace(/\s+/g,' ')}
function agregarTag(texto){
    const t=normalizarTag(texto);if(!t||t.length<2)return;
    const existe=AppState.datos.tags.find(x=>x.toLowerCase()===t.toLowerCase());
    if(!existe){AppState.datos.tags.push(t);AppState.datos.tags.sort((a,b)=>a.localeCompare(b,'es'))}
}
function eliminarTag(texto){AppState.datos.tags=AppState.datos.tags.filter(t=>t.toLowerCase()!==texto.toLowerCase())}
function editarTag(viejo,nuevo){
    const nv=normalizarTag(nuevo);if(!nv||nv.length<2)return false;
    const dup=AppState.datos.tags.find(t=>t.toLowerCase()===nv.toLowerCase()&&t.toLowerCase()!==viejo.toLowerCase());
    if(dup)return false;
    const idx=AppState.datos.tags.findIndex(t=>t.toLowerCase()===viejo.toLowerCase());
    if(idx>=0){AppState.datos.tags[idx]=nv;AppState.datos.tags.sort((a,b)=>a.localeCompare(b,'es'))}
    return true;
}
function renderizarTagsSugerencias(inputId,containerId){
    const input=$(inputId),cont=$(containerId);if(!cont||!input)return;
    const val=input.value.toLowerCase().trim(),tags=AppState.datos.tags||[];
    if(!tags.length){cont.innerHTML='';return}
    const filtrados=val?tags.filter(t=>t.toLowerCase().includes(val)):tags.slice(0,15);
    if(!filtrados.length){cont.innerHTML='';return}
    let h='<div class="tag-sugerencias"><div class="tag-sugerencias-label">ğŸ·ï¸ Etiquetas:</div><div class="tags-container">';
    filtrados.forEach(t=>{h+=`<span class="tag-pill" data-action="usar-tag" data-tag="${t.replace(/"/g,'&quot;')}" data-target="${inputId}">${t}</span>`});
    h+='</div></div>';cont.innerHTML=h;
}
function renderizarGestionTags(){
    const tags=AppState.datos.tags||[],search=($('tagSearch')?.value||'').toLowerCase();
    const cont=$('tagsList');if(!cont)return;
    const filtrados=search?tags.filter(t=>t.toLowerCase().includes(search)):tags;
    if(!filtrados.length){cont.innerHTML=`<div style="text-align:center;padding:20px;color:#94a3b8"><div style="font-size:1.8em;margin-bottom:6px">ğŸ·ï¸</div><div>${search?'Sin resultados':'Sin etiquetas aÃºn'}</div><div style="font-size:0.8em;margin-top:4px">${search?'':'Las etiquetas se crean automÃ¡ticamente al escribir descripciones'}</div></div>`;return}
    let h='';
    filtrados.forEach(t=>{
        const usos=AppState.datos.movimientos.filter(m=>(m.descripcion||'').toLowerCase()===t.toLowerCase()).length;
        h+=`<div class="tag-manage-item"><span class="tag-name">${t}</span><span class="tag-count">${usos} uso${usos!==1?'s':''}</span><div class="tag-actions"><button class="tag-edit-btn" data-action="editar-tag" data-tag="${t.replace(/"/g,'&quot;')}">âœï¸</button><button class="tag-delete-btn" data-action="eliminar-tag" data-tag="${t.replace(/"/g,'&quot;')}">ğŸ—‘ï¸</button></div></div>`;
    });
    cont.innerHTML=h;
}
function getLotesActivosFIFO(){return AppState.datos.lotes.filter(l=>l.disponible>0).sort((a,b)=>(a.fecha+(a.hora||'00:00')).localeCompare(b.fecha+(b.hora||'00:00')))}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Â§5 â€” PAGINACIÃ“N GENÃ‰RICA
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function crearPaginacion(cfg) {
    const {getTotal,getPag,setPag,porPag,ids,renderFn} = cfg;
    function totalPags(){return Math.max(1,Math.ceil(getTotal()/porPag))}
    function render(){
        const total=getTotal();
        if(!total){$(ids.pagination).style.display='none';renderFn([],0,0);return}
        let pag=getPag(),tp=totalPags();
        if(pag>tp){pag=tp;setPag(pag)}
        if(pag<1){pag=1;setPag(pag)}
        const ini=(pag-1)*porPag,fin=ini+porPag;
        renderFn(ini,fin,total);
        $(ids.pagination).style.display=tp>1?'flex':'none';
        setText(ids.info,`${pag} / ${tp}`);
        $(ids.prev).disabled=pag===1;
        $(ids.next).disabled=pag===tp;
    }
    function cambiar(dir){
        let pag=getPag()+dir,tp=totalPags();
        if(pag<1)pag=1;if(pag>tp)pag=tp;setPag(pag);render();
    }
    return{render,cambiar};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Â§6 â€” BANCOS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function inicializarBancos(){
    CONFIG.BANCOS.forEach(b=>{
        if(!AppState.datos.bancos[b.nombre])
            AppState.datos.bancos[b.nombre]={activo:false,saldo:0,limiteDiarioUSD:0,limiteUsadoUSD:0,ultimoResetLimite:null};
        else{
            const bk=AppState.datos.bancos[b.nombre];
            if(bk.limiteDiarioUSD===undefined)bk.limiteDiarioUSD=bk.limiteDiario||0;
            if(bk.limiteUsadoUSD===undefined)bk.limiteUsadoUSD=bk.limiteUsado||0;
            if(bk.ultimoResetLimite===undefined)bk.ultimoResetLimite=null;
        }
    });
}

function verificarResetLimites(){
    const ah=getUDate(),hr=0.5,ha=ah.getHours()+ah.getMinutes()/60,hoy=getUDateStr();
    CONFIG.BANCOS.forEach(b=>{
        const bk=AppState.datos.bancos[b.nombre];if(!bk)return;
        if(!bk.ultimoResetLimite)bk.ultimoResetLimite=null;
        const ur=bk.ultimoResetLimite;
        if(b.especial==='itau'){
            const ds=ah.getDay();
            if(ds===2&&ha>=hr){if(ur!==hoy){bk.limiteUsadoUSD=0;bk.ultimoResetLimite=hoy}}
            else if(ds>2&&ds<6&&ha>=hr){if(ur!==hoy){bk.limiteUsadoUSD=0;bk.ultimoResetLimite=hoy}}
        }else{if(ha>=hr&&ur!==hoy){bk.limiteUsadoUSD=0;bk.ultimoResetLimite=hoy}}
    });
}

function getMonedaBanco(){const b=$('banco')?.value;if(!b)return'UYU';return getBancoInfo(b)?.moneda||'UYU'}
function getComisionActual(){return getMonedaBanco()==='USD'?AppState.datos.comisionUSD:AppState.datos.comisionPlataforma}
function getComisionDec(){return(getComisionActual()||0.14)/100}
function getBancosActivos(){return CONFIG.BANCOS.filter(b=>AppState.datos.bancos[b.nombre]?.activo)}

function actualizarSelectBancos(){
    const s=$('banco'),v=s.value;
    s.innerHTML='<option value="">-- Seleccionar --</option>';
    getBancosActivos().forEach(b=>{s.innerHTML+=`<option value="${b.nombre}" style="color:${b.color||'#1e293b'};font-weight:600">${b.nombre}</option>`});
    s.value=v;actualizarColorBancoSelect();
}

function mostrarSaldoBanco(){
    const b=$('banco').value,i=$('saldoBancoInfo'),h=$('bancoHelp');
    if(h){h.textContent='';h.className=''}
    if(b&&AppState.datos.bancos[b]){const bi=getBancoInfo(b);i.innerHTML=' | <span style="color:'+getBancoColor(b)+';font-weight:600">'+b+'</span>: '+getSym(bi?.moneda)+fmtNum(AppState.datos.bancos[b].saldo)}
    else i.textContent='';
}

function actualizarBancosGrid(){
    const la=AppState.datos.lotes.filter(l=>l.disponible>0).length;
    let h=`<div class="banco-mini-card usdt-card" data-action="inventario"><div class="banco-nombre">ğŸª™ <b style="color:#1e293b">USDT</b></div><div class="banco-saldo">${fmtTrunc(Math.max(0,AppState.datos.saldoUsdt),2)}</div><div class="banco-moneda">Tether Â· ${la} lotes</div></div>`;
    CONFIG.BANCOS.forEach(b=>{
        if(!AppState.datos.bancos[b.nombre]?.activo)return;
        const s=AppState.datos.bancos[b.nombre].saldo,lim=AppState.datos.bancos[b.nombre].limiteDiarioUSD||0,us=AppState.datos.bancos[b.nombre].limiteUsadoUSD||0;
        let lh='';
        if(lim>0){const disp=Math.max(0,lim-us),pct=Math.min(100,(us/lim)*100);let fc='';if(pct>=90)fc='danger';else if(pct>=70)fc='warning';
            lh=`<div class="banco-limite">US$${fmtNum(disp,0)}/${fmtNum(lim,0)}</div><div class="banco-limite-bar"><div class="banco-limite-fill ${fc}" style="width:${pct}%"></div></div>`}
        h+=`<div class="banco-mini-card" data-action="editar-saldo" data-banco="${b.nombre}"><div class="banco-nombre" style="color:${b.color||'#1e293b'}">${b.nombre}</div><div class="banco-saldo" style="color:${s>=0?'#16a34a':'#dc2626'}">${getSym(b.moneda)}${fmtNum(s)}</div><div class="banco-moneda">${b.moneda}</div>${lh}</div>`;
    });
    setHtml('bancosGrid',h);
}

function renderizarListaBancos(){
    let h='';
    CONFIG.BANCOS.forEach(b=>{
        const a=AppState.datos.bancos[b.nombre]?.activo||false,s=AppState.datos.bancos[b.nombre]?.saldo||0,lim=AppState.datos.bancos[b.nombre]?.limiteDiarioUSD||0;
        let li=lim>0?` | LÃ­mite: US$${fmtNum(lim,0)}/dÃ­a`:'';if(b.especial==='itau')li+=' (sÃ¡b-lun=1dÃ­a)';
        h+=`<div class="banco-list-item"><div><div style="font-weight:600;font-size:0.9em"><span style="color:${b.color||'#1e293b'}">${b.nombre}</span> <span style="color:#94a3b8">(${b.moneda})</span></div><div style="color:#64748b;font-size:0.8em">${getSym(b.moneda)}${fmtNum(s)}${li}</div></div><div class="banco-list-actions"><button class="btn-edit-small" data-action="editar-saldo" data-banco="${b.nombre}">Editar</button><label class="toggle-switch"><input type="checkbox" ${a?'checked':''} data-action="toggle-banco" data-banco="${b.nombre}"><span class="toggle-slider"></span></label></div></div>`;
    });
    setHtml('listaBancos',h);
}

function mostrarSaldoOrigen(){
    const b=$('bancoOrigen')?.value;
    if(b&&AppState.datos.bancos[b]){
        const bi=getBancoInfo(b),sym=getSym(bi?.moneda);let info=colorBanco(b)+': '+sym+fmtNum(AppState.datos.bancos[b].saldo);
        if(AppState.datos.bancos[b].limiteDiarioUSD>0){const u=AppState.datos.bancos[b].limiteUsadoUSD||0,d=Math.max(0,AppState.datos.bancos[b].limiteDiarioUSD-u);info+=` | LÃ­mite: US$${fmtNum(d,0)}/${fmtNum(AppState.datos.bancos[b].limiteDiarioUSD,0)}`}
        $('saldoOrigenInfo').innerHTML=info;
    }else $('saldoOrigenInfo').textContent='';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Â§7 â€” INVENTARIO FIFO
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function agregarLote(id,fecha,hora,precio,cant,moneda){
    moneda=moneda||'UYU';cant=truncUsdt(cant);
    const ex=AppState.datos.lotes.find(l=>l.precioCompra===precio&&l.disponible>0&&(l.moneda||'UYU')===moneda);
    if(ex){ex.cantidad=truncUsdt(ex.cantidad+cant);ex.disponible=truncUsdt(ex.disponible+cant)}
    else AppState.datos.lotes.push({id,fecha,hora,precioCompra:precio,cantidad:cant,disponible:cant,moneda});
}

function consumirFIFO(cant,precioVenta,monedaVenta){
    let rest=truncUsdt(cant),gan=0,costo=0;const lotes=getLotesActivosFIFO();
    for(const l of lotes){if(rest<=0)break;const c=truncUsdt(Math.min(l.disponible,rest));
        costo=roundMoney(costo+roundMoney(c*l.precioCompra));
        if(precioVenta!==undefined&&(l.moneda||'UYU')===(monedaVenta||'UYU'))gan=roundMoney(gan+roundMoney(c*(precioVenta-l.precioCompra)));
        l.disponible=truncUsdt(l.disponible-c);if(l.disponible<0.005)l.disponible=0;rest=truncUsdt(rest-c);if(rest<0.005)rest=0}
    return{ganancia:gan,costo};
}
function previewFIFO(cant){
    let rest=truncUsdt(cant);const lotes=getLotesActivosFIFO(),res=[];
    for(const l of lotes){if(rest<=0)break;const c=truncUsdt(Math.min(l.disponible,rest));
        res.push({precio:l.precioCompra,cantidad:c,subtotal:roundMoney(c*l.precioCompra)});rest=truncUsdt(rest-c);if(rest<0.005)rest=0}
    return res;
}

function recalcularLotesYGanancias(){
    AppState.datos.lotes=[];const ev=[];
    AppState.datos.operaciones.forEach(op=>{ev.push({tipo:'op',fecha:op.fecha,hora:op.hora||'00:00',data:op})});
    AppState.datos.movimientos.filter(m=>m.tipoCuenta==='usdt').forEach(m=>{
        ev.push({tipo:m.tipoMovimiento==='ingreso'?'mi':'me',fecha:m.fecha,hora:m.hora||'00:00',data:m})});
    ev.sort((a,b)=>(a.fecha+(a.hora||'00:00')).localeCompare(b.fecha+(b.hora||'00:00')));
    let utcL=AppState.datos.ultimaTasaCompra||0,utcUL=AppState.datos.ultimaTasaCompraUSD||0,utvU=0;
    ev.forEach(e=>{
        if(e.tipo==='op'){
            const op=e.data,cpct=(op.comisionPct||0.14)/100;
            /* op.usdt ya viene truncado a 2dp si fue creado con cÃ³digo nuevo.
               Para datos legacy (pre-fix), re-truncamos por seguridad. */
            const uTrunc=truncUsdt(op.usdt),cp=truncar(uTrunc*cpct,2),isU=op.moneda==='USD';
            if(op.tipo==='compra'){
                const un=truncUsdt(uTrunc-cp);
                if(isU){
                    op.ganancia=roundMoney((utvU>0?roundMoney(un*(utvU-op.tasa)):0)-(op.comisionBanco||0));
                    utcUL=op.tasa;
                }else{utcL=op.tasa;op.ganancia=roundMoney(-(op.comisionBanco||0))}
                agregarLote(op.id,op.fecha,op.hora||'00:00',op.tasa,un,op.moneda||'UYU');
            }else{
                const av=truncUsdt(uTrunc+cp);
                const fifoGan=consumirFIFO(av,op.tasa,op.moneda||'UYU').ganancia;
                if(isU){utvU=op.tasa;AppState.datos.ultimaTasaVentaUSD=op.tasa;op.ganancia=roundMoney(fifoGan)}
                else{AppState.datos.ultimaTasaVenta=op.tasa;op.ganancia=roundMoney(fifoGan)}
            }
            /* Normalizar op.usdt y comisionPlataforma con valores truncados */
            op.usdt=uTrunc;op.comisionPlataforma=cp;
        }else if(e.tipo==='mi'){const m=e.data,pr=m.tasaRef||utcL||1;agregarLote(m.id,m.fecha,m.hora||'00:00',pr,roundMoney(m.monto),'UYU')}
        else if(e.tipo==='me'){const r=consumirFIFO(roundMoney(e.data.monto));e.data.valorUYU=r.costo}
    });
    AppState.datos.ultimaTasaCompra=utcL;AppState.datos.ultimaTasaCompraUSD=utcUL;sincronizarSaldoUsdt();
}

function renderizarInventario(){
    const la=getLotesActivosFIFO();
    if(!la.length){setHtml('inventarioContent','<div style="text-align:center;padding:30px;color:#94a3b8"><div style="font-size:2em;margin-bottom:8px">ğŸ“­</div><div>Sin USDT en inventario</div></div>');return}
    let tot=0,h='<table style="min-width:auto"><thead><tr><th>#</th><th>Precio</th><th>Disponible</th><th>Valor</th><th></th></tr></thead><tbody>';
    la.forEach((l,i)=>{tot+=l.disponible;const mon=l.moneda||'UYU',sy=mon==='USD'?'US$':'$',v=truncar(l.disponible*l.precioCompra,2);
        h+=`<tr><td style="color:#64748b">${i+1}</td><td><b>${sy}${fmtNum(l.precioCompra,mon==='USD'?3:2)}</b></td><td style="color:#2563eb"><b>${fmtTrunc(l.disponible,2)}</b></td><td style="color:#64748b">${sy}${fmtNum(v,mon==='USD'?2:0)}</td><td><button class="btn-edit-small" data-action="editar-lote" data-lote-id="${l.id}">âœï¸</button></td></tr>`});
    h+=`</tbody></table><div style="margin-top:12px;padding:10px;background:#eff6ff;border-radius:8px;display:flex;justify-content:space-between"><span style="color:#64748b">Total en inventario:</span><span style="color:#2563eb;font-weight:bold">${fmtTrunc(tot,2)} USDT</span></div>`;
    setHtml('inventarioContent',h);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Â§8 â€” FIREBASE & AUTH
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function userToEmail(u){return u.toLowerCase().trim()+CONFIG.EMAIL_DOMAIN}
function emailToUser(e){return e.replace(CONFIG.EMAIL_DOMAIN,'')}

async function guardarDatos(){
    if(!AppState.currentUser)return;setSyncStatus('syncing','...');
    try{await AppState.db.collection('users').doc(AppState.currentUser.uid).set({...AppState.datos,ultimaActualizacion:firebase.firestore.FieldValue.serverTimestamp()});setSyncStatus('online','âœ“')}
    catch(e){setSyncStatus('offline','âœ—')}
}

function cargarDatosUsuario(){
    if(!AppState.currentUser)return;
    if(AppState.unsubscribe)AppState.unsubscribe();
    AppState.unsubscribe=AppState.db.collection('users').doc(AppState.currentUser.uid).onSnapshot(doc=>{
        const ci=$('comisionPlataforma'),cf=document.activeElement===ci,lcU=AppState.datos.comisionPlataforma,lcD=AppState.datos.comisionUSD;
        if(doc.exists){const d=doc.data();AppState.datos={operaciones:d.operaciones||[],movimientos:d.movimientos||[],transferencias:d.transferencias||[],conversiones:d.conversiones||[],bancos:d.bancos||{},lotes:d.lotes||[],tags:d.tags||[],saldoUsdt:d.saldoUsdt||0,ultimaTasaCompra:d.ultimaTasaCompra||0,ultimaTasaVenta:d.ultimaTasaVenta||0,comisionPlataforma:d.comisionPlataforma!==undefined?d.comisionPlataforma:0.14,ultimaTasaCompraUSD:d.ultimaTasaCompraUSD||0,ultimaTasaVentaUSD:d.ultimaTasaVentaUSD||0,comisionUSD:d.comisionUSD!==undefined?d.comisionUSD:0.14}}
        else AppState.datos=crearDatosVacios();
        if(cf){AppState.datos.comisionPlataforma=lcU;AppState.datos.comisionUSD=lcD}
        inicializarBancos();verificarResetLimites();
        /* MigraciÃ³n: normalizar datos legacy + recalcular con redondeo Binance-matching */
        const needsMigration=AppState.datos.lotes.some(l=>!l.moneda)||AppState.datos.operaciones.some(op=>op.ganancia===undefined)||AppState.datos.operaciones.some(op=>{const exp=truncUsdt(op.monto/op.tasa);return Math.abs(op.usdt-exp)>0.001});
        if(needsMigration){
            /* Normalizar op.usdt a 2dp redondeado (Binance-matching) antes de recalcular */
            AppState.datos.operaciones.forEach(op=>{
                const exp=truncUsdt(op.monto/op.tasa);
                if(Math.abs(op.usdt-exp)>0.001){
                    op.usdt=exp;
                    op.comisionPlataforma=truncar(op.usdt*((op.comisionPct||0.14)/100),2);
                }
            });
            recalcularLotesYGanancias();guardarDatos()
        }
        AppState.ui.paginaOp=1;AppState.ui.paginaMov=1;AppState.ui.paginaTrans=1;AppState.ui.paginaConv=1;
        if(!cf){const mon=getMonedaBanco(),cv=mon==='USD'?AppState.datos.comisionUSD:AppState.datos.comisionPlataforma;ci.value=cv.toFixed(2);setText('comisionPctLabel',cv.toFixed(2))}
        actualizarVista();actualizarFormulario();actualizarColorSelect();ocultarLoading();setSyncStatus('online','âœ“');
    },()=>{setSyncStatus('offline','âœ—');ocultarLoading()});
}

function showApp(u){AppState.currentUser=u;setText('menuUserName',emailToUser(u.email));setText('menuUserEmail',u.email);$('authContainer').classList.add('hidden');$('appContainer').classList.add('active');cargarDatosUsuario()}
function showAuth(){AppState.currentUser=null;$('authContainer').classList.remove('hidden');$('appContainer').classList.remove('active');['loginBtn','registerBtn'].forEach(id=>{const b=$(id);b.disabled=false;b.textContent=id==='loginBtn'?'Iniciar SesiÃ³n':'Crear Cuenta'});['loginUser','loginPass','regUser','regPass','regPassConfirm'].forEach(id=>{const e=$(id);if(e)e.value=''});ocultarLoading()}

function inicializarFirebase(){
    if(typeof firebase==='undefined'){ocultarLoading();return}
    firebase.initializeApp(CONFIG.firebase);AppState.auth=firebase.auth();AppState.db=firebase.firestore();
    AppState.db.enablePersistence().catch(()=>{});
    AppState.auth.onAuthStateChanged(u=>u?showApp(u):showAuth());
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Â§9 â€” FORMULARIO OPERACIÃ“N
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function actualizarColorSelect(){const s=$('tipo');s.style.color=s.value==='compra'?'#16a34a':'#dc2626'}
function actualizarColorBancoSelect(){const s=$('banco'),v=s.value;s.style.color=v?getBancoColor(v):'#1e293b';s.style.fontWeight=v?'600':'400'}

function actualizarFormulario(){
    const t=$('tipo').value,mon=getMonedaBanco(),isU=mon==='USD';
    const prevMon=AppState.ui.ultimoMonedaBanco;
    const monedaCambiada=prevMon!==null&&prevMon!==mon;
    AppState.ui.ultimoMonedaBanco=mon;
    setText('montoLabel',t==='compra'?`PagÃ¡s (${mon})`:`RecibÃ­s (${mon})`);
    setText('bancoLabel',t==='compra'?'Sale de *':'Entra a *');
    $('comisionBancoGroup').style.display=t==='compra'?'block':'none';
    if(t==='venta')$('comisionBanco').value='0';
    const ti=$('tasa');
    if(document.activeElement!==ti&&(!AppState.ui.tasaManual||monedaCambiada)){
        const ta=t==='compra'?(isU?AppState.datos.ultimaTasaCompraUSD:AppState.datos.ultimaTasaCompra):(isU?AppState.datos.ultimaTasaVentaUSD:AppState.datos.ultimaTasaVenta);
        ti.value=ta>0?fmtTasa(ta,mon):'';
        if(monedaCambiada)AppState.ui.tasaManual=false;
    }
    setText('tasaHelp',isU?'Ej: 1.025':'Ej: 39.50');
    const ci=$('comisionPlataforma');if(document.activeElement!==ci){const cv=isU?AppState.datos.comisionUSD:AppState.datos.comisionPlataforma;ci.value=cv.toFixed(2);setText('comisionPctLabel',cv.toFixed(2))}
    calcularPreview();
}

function calcularPreview(){
    const t=$('tipo').value,m=parseFloat($('monto').value)||0,ta=parsearTasa($('tasa').value),cp=getComisionDec(),mon=getMonedaBanco(),isU=mon==='USD';
    $('tasa').classList.remove('error');const th=$('tasaHelp');th.className='';th.textContent=isU?'Ej: 1.025':'Ej: 39.50';
    if(m>0&&ta){
        /* Binance-matching: truncar USDT total a 2dp ANTES de calcular comisiÃ³n */
        const u=truncUsdt(m/ta),c=truncar(u*cp,2);
        setText('comisionPlataformaInfo',fmtTrunc(c,2)+' USDT');
        const neto=t==='compra'?truncUsdt(u-c):truncUsdt(u+c);
        $('previewText').innerHTML=t==='compra'
            ?`ğŸ“¥ RecibÃ­s <b>${fmtTrunc(neto,2)} USDT</b> <span style="color:#64748b;font-size:0.85em">(total: ${fmtTrunc(u,2)})</span>`
            :`ğŸ“¤ EntregÃ¡s <b>${fmtTrunc(neto,2)} USDT</b>`;
        $('previewBox').style.display='block'}
    else{$('previewBox').style.display='none';setText('comisionPlataformaInfo','0 USDT')}
}

function guardarComisionYCalcular(){
    const inp=$('comisionPlataforma'),raw=inp.value.replace(',','.').trim();
    if(raw!==''&&raw!=='.'){const v=parsearComision(raw);if(v!==null){
        if(getMonedaBanco()==='USD')AppState.datos.comisionUSD=v;else AppState.datos.comisionPlataforma=v;
        setText('comisionPctLabel',v.toFixed(2));clearTimeout(AppState.ui.comisionDebounce);AppState.ui.comisionDebounce=setTimeout(()=>guardarDatos(),1200)}}
    calcularPreview();
}

async function agregarOperacion(){
    if(AppState.ui.enCooldown||AppState.ui.guardandoOperacion)return;const btn=$('btnAgregarOp');if(btn.disabled)return;
    const t=$('tipo').value,m=parseFloat($('monto').value),ti=$('tasa'),ta=parsearTasa(ti.value),b=$('banco').value,cb=roundMoney(parseFloat($('comisionBanco').value)||0),f=getUDateStr(),h=getUTimeStr(),mon=getMonedaBanco(),isU=mon==='USD',cpv=getComisionActual(),cp=cpv/100;
    if(!m){alert('IngresÃ¡ el monto');return}
    if(!ta){ti.classList.add('error');$('tasaHelp').textContent='Formato invÃ¡lido';$('tasaHelp').className='error-text';alert('Tasa invÃ¡lida (ej: '+(isU?'1.025':'39.50')+')');return}
    if(!b){$('bancoHelp').textContent='SeleccionÃ¡ un banco';$('bancoHelp').className='error-text';$('banco').classList.add('error');alert('SeleccionÃ¡ un banco');return}
    $('banco').classList.remove('error');
    /* â•â•â• Binance-matching: truncar USDT total a 2dp ANTES de comisiÃ³n â•â•â• */
    const u=truncUsdt(m/ta), cpl=truncar(u*cp,2);
    if(t==='compra'){const bk=AppState.datos.bancos[b];if(bk.limiteDiarioUSD>0){const mU=isU?m:truncUsdt(m/ta),dU=roundMoney(bk.limiteDiarioUSD-(bk.limiteUsadoUSD||0));if(mU>dU){alert(`Excede el lÃ­mite diario. Disponible: US$${fmtNum(dU,0)} (${fmtNum(mU,2)} USD requeridos)`);return}}if(bk.saldo<m+cb&&!confirm('Saldo insuficiente en '+b+'. Â¿Continuar?'))return}
    else{const un=truncUsdt(u+cpl);if(AppState.datos.saldoUsdt<un&&!confirm(`Solo tenÃ©s ${fmtTrunc(AppState.datos.saldoUsdt,2)} USDT. Â¿Continuar?`))return}
    AppState.ui.guardandoOperacion=true;btn.disabled=true;btn.textContent='Guardando...';
    try{
        const opId=Date.now();let gan=0;
        if(t==='compra'){
            const un=truncUsdt(u-cpl);
            if(isU){
                gan=AppState.datos.ultimaTasaVentaUSD>0?roundMoney(un*(AppState.datos.ultimaTasaVentaUSD-ta)):0;
                gan=roundMoney(gan-cb);
                AppState.datos.ultimaTasaCompraUSD=ta;
            }else{AppState.datos.ultimaTasaCompra=ta;gan=roundMoney(-cb)}
            agregarLote(opId,f,h,ta,un,mon);
            AppState.datos.bancos[b].saldo=fixNeg(AppState.datos.bancos[b].saldo-(m+cb));sincronizarSaldoUsdt();
            if(AppState.datos.bancos[b].limiteDiarioUSD>0){const mU=isU?m:truncUsdt(m/ta);AppState.datos.bancos[b].limiteUsadoUSD=Math.min(AppState.datos.bancos[b].limiteDiarioUSD,roundMoney((AppState.datos.bancos[b].limiteUsadoUSD||0)+mU))}
        }
        else{const av=truncUsdt(u+cpl);gan=consumirFIFO(av,ta,mon).ganancia;if(isU)AppState.datos.ultimaTasaVentaUSD=ta;else AppState.datos.ultimaTasaVenta=ta;AppState.datos.bancos[b].saldo=fixNeg(AppState.datos.bancos[b].saldo+m);sincronizarSaldoUsdt()}
        /* u almacenado ya es truncado a 2dp (= "Cantidad total" de Binance) */
        AppState.datos.operaciones.unshift({id:opId,tipo:t,monto:m,tasa:ta,usdt:u,banco:b,moneda:mon,comisionBanco:t==='compra'?cb:0,comisionPlataforma:cpl,comisionPct:cpv,fecha:f,hora:h,ganancia:roundMoney(gan),timestamp:new Date().toISOString()});
        $('monto').value='';$('comisionBanco').value='0';$('previewBox').style.display='none';AppState.ui.paginaOp=1;AppState.ui.tasaManual=false;
        await guardarDatos();actualizarVista();activarCooldown();
    }finally{AppState.ui.guardandoOperacion=false;btn.disabled=false;btn.textContent='Agregar OperaciÃ³n'}
}

async function eliminarOperacion(id){
    if(!confirm('Â¿Eliminar operaciÃ³n? Se recalcularÃ¡n los lotes y ganancias.'))return;
    const op=AppState.datos.operaciones.find(o=>o.id===id);
    if(op){if(op.tipo==='compra'){if(op.banco&&AppState.datos.bancos[op.banco]){AppState.datos.bancos[op.banco].saldo=fixNeg(AppState.datos.bancos[op.banco].saldo+roundMoney(op.monto+(op.comisionBanco||0)));if(AppState.datos.bancos[op.banco].limiteDiarioUSD>0){const mU=roundMoney(op.monto/op.tasa);AppState.datos.bancos[op.banco].limiteUsadoUSD=Math.max(0,roundMoney((AppState.datos.bancos[op.banco].limiteUsadoUSD||0)-mU))}}}else{if(op.banco&&AppState.datos.bancos[op.banco])AppState.datos.bancos[op.banco].saldo=fixNeg(AppState.datos.bancos[op.banco].saldo-op.monto)}}
    AppState.datos.operaciones=AppState.datos.operaciones.filter(o=>o.id!==id);
    recalcularLotesYGanancias();await guardarDatos();actualizarVista();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Â§10 â€” MOVIMIENTOS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function abrirModalMovimiento(){
    AppState.ui.guardandoMovimiento=false;AppState.ui.tipoMovimiento='ingreso';
    $('tabIngreso').className='tab tab-ingreso active';$('tabEgreso').className='tab tab-egreso';
    $('movTipoCuenta').value='banco';$('movMonto').value='';$('movTasaRef').value='';$('movDescripcion').value='';$('btnGuardarMov').disabled=false;$('btnGuardarMov').textContent='Guardar';
    actualizarCuentasMovimiento();renderizarTagsSugerencias('movDescripcion','tagSugerenciasMov');abrirModal('modalMovimiento');
}
function setTipoMovimiento(t){AppState.ui.tipoMovimiento=t;$('tabIngreso').className='tab tab-ingreso'+(t==='ingreso'?' active':'');$('tabEgreso').className='tab tab-egreso'+(t==='egreso'?' active':'');actualizarCuentasMovimiento()}
function actualizarCuentasMovimiento(){
    const tc=$('movTipoCuenta').value;$('movBancoGroup').style.display=tc==='usdt'?'none':'block';setText('movMontoLabel',tc==='usdt'?'Monto (USDT)':'Monto');
    const esUsdtIngreso=tc==='usdt'&&AppState.ui.tipoMovimiento==='ingreso';
    $('movTasaRefGroup').style.display=esUsdtIngreso?'block':'none';
    if(esUsdtIngreso){$('movTasaRef').value=AppState.datos.ultimaTasaCompra||'';setText('movTasaRefLabel','Tasa referencia (precio de compra)')}
    const fp=$('movFifoPreview');if(fp)fp.style.display=tc==='usdt'&&AppState.ui.tipoMovimiento==='egreso'?'block':'none';
    if(tc!=='usdt'){const s=$('movBanco');s.innerHTML='<option value="">Seleccionar banco</option>';getBancosActivos().forEach(b=>{s.innerHTML+=`<option value="${b.nombre}" style="color:${b.color||'#1e293b'};font-weight:600">${b.nombre}</option>`})}
    actualizarFifoPreview();
}
function actualizarFifoPreview(){
    const fp=$('movFifoPreview');if(!fp)return;
    const tc=$('movTipoCuenta').value,m=parseFloat($('movMonto').value)||0;
    if(tc!=='usdt'||AppState.ui.tipoMovimiento!=='egreso'||m<=0){fp.innerHTML='<div style="color:#94a3b8;font-size:0.8em">IngresÃ¡ un monto para ver los lotes que se consumirÃ¡n</div>';return}
    const lots=previewFIFO(m);
    if(!lots.length){fp.innerHTML='<div style="color:#dc2626;font-size:0.8em">âš ï¸ Sin lotes disponibles</div>';return}
    let tot=0,h='<div style="font-size:0.75em;color:#64748b;margin-bottom:4px"><b>Lotes FIFO a consumir:</b></div>';
    lots.forEach(l=>{tot+=l.subtotal;h+=`<div style="font-size:0.8em;padding:3px 0;display:flex;justify-content:space-between"><span>${fmtTrunc(l.cantidad,2)} USDT Ã— $${fmtNum(l.precio)}</span><span style="color:#64748b">= $${fmtNum(l.subtotal)}</span></div>`});
    h+=`<div style="font-size:0.8em;padding:5px 0 0;border-top:1px solid #e2e8f0;margin-top:4px;display:flex;justify-content:space-between;font-weight:600"><span>Costo real total:</span><span style="color:#2563eb">$${fmtNum(tot)}</span></div>`;
    fp.innerHTML=h;
}

async function guardarMovimiento(){
    if(AppState.ui.guardandoMovimiento||AppState.ui.enCooldown)return;
    const btn=$('btnGuardarMov');if(btn.disabled)return;
    const tc=$('movTipoCuenta').value,b=$('movBanco').value,m=parseFloat($('movMonto').value),desc=$('movDescripcion').value,f=getUDateStr(),tRef=tc==='usdt'&&AppState.ui.tipoMovimiento==='ingreso'?parseFloat($('movTasaRef').value)||0:0;
    if(!m||m<=0)return alert('Monto invÃ¡lido');if(tc==='banco'&&!b)return alert('SeleccionÃ¡ un banco');
    if(tc==='usdt'&&AppState.ui.tipoMovimiento==='ingreso'&&(!tRef||tRef<=0))return alert('IngresÃ¡ una tasa de referencia vÃ¡lida');
    AppState.ui.guardandoMovimiento=true;btn.disabled=true;btn.textContent='Guardando...';
    try{
        const mId=Date.now(),mR=tc==='usdt'?truncUsdt(m):roundMoney(m);let vUYU=0;
        if(tc==='usdt'){
            if(AppState.ui.tipoMovimiento==='ingreso'){
                vUYU=0;agregarLote(mId,f,getUTimeStr(),tRef,mR,'UYU');
            }else{
                if(AppState.datos.saldoUsdt<mR&&!confirm(`Solo tenÃ©s ${fmtTrunc(AppState.datos.saldoUsdt,2)} USDT en inventario. Â¿Continuar?`)){AppState.ui.guardandoMovimiento=false;btn.disabled=false;btn.textContent='Guardar';return}
                const r=consumirFIFO(mR);vUYU=r.costo;
            }
            sincronizarSaldoUsdt();
        }else{
            if(AppState.ui.tipoMovimiento==='egreso')vUYU=mR;
            AppState.datos.bancos[b].saldo=fixNeg(AppState.datos.bancos[b].saldo+(AppState.ui.tipoMovimiento==='ingreso'?mR:-mR));
        }
        const md={id:mId,tipoMovimiento:AppState.ui.tipoMovimiento,tipoCuenta:tc,banco:tc==='banco'?b:null,monto:mR,valorUYU:AppState.ui.tipoMovimiento==='egreso'?roundMoney(vUYU):0,tasaRef:tc==='usdt'&&AppState.ui.tipoMovimiento==='ingreso'?tRef:0,descripcion:desc,fecha:f,hora:getUTimeStr(),timestamp:new Date().toISOString()};
        if(desc)agregarTag(desc);
        AppState.datos.movimientos.unshift(md);await guardarDatos();actualizarVista();cerrarModal('modalMovimiento');activarCooldown();
    }finally{AppState.ui.guardandoMovimiento=false;btn.disabled=false;btn.textContent='Guardar'}
}

async function eliminarMovimiento(id){
    if(!confirm('Â¿Eliminar?'))return;const mv=AppState.datos.movimientos.find(m=>m.id===id);
    if(mv){if(mv.tipoCuenta==='usdt'){AppState.datos.movimientos=AppState.datos.movimientos.filter(m=>m.id!==id);recalcularLotesYGanancias()}else{if(mv.banco&&AppState.datos.bancos[mv.banco])AppState.datos.bancos[mv.banco].saldo=fixNeg(AppState.datos.bancos[mv.banco].saldo+(mv.tipoMovimiento==='ingreso'?-mv.monto:mv.monto));AppState.datos.movimientos=AppState.datos.movimientos.filter(m=>m.id!==id)}}
    else AppState.datos.movimientos=AppState.datos.movimientos.filter(m=>m.id!==id);
    await guardarDatos();actualizarVista();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Â§11 â€” TRANSFERENCIAS (+ CONVERSIÃ“N INTEGRADA)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function hayBancosUSD(){return CONFIG.BANCOS.some(b=>AppState.datos.bancos[b.nombre]?.activo&&b.moneda==='USD')}

function esCrossMoneda(){
    const o=$('bancoOrigen')?.value,d=$('bancoDestino')?.value;
    if(!o||!d)return false;
    const oi=getBancoInfo(o),di=getBancoInfo(d);
    return oi&&di&&oi.moneda!==di.moneda;
}

function actualizarTransfUI(){
    const cross=esCrossMoneda(),tg=$('transfTasaGroup'),pv=$('transfConvPreview'),hd=$('transfHeader');
    tg.style.display=cross?'block':'none';
    if(cross){hd.textContent='ğŸ’± ConversiÃ³n entre monedas';$('btnTransferir').textContent='Convertir';$('btnTransferir').style.background='#7c3aed'}
    else{hd.textContent='â†”ï¸ Transferencia entre Bancos';$('btnTransferir').textContent='Transferir';$('btnTransferir').style.background='#2563eb';pv.style.display='none'}
    actualizarTransfPreview();
}

function actualizarTransfPreview(){
    const pv=$('transfConvPreview');if(!esCrossMoneda()){pv.style.display='none';return}
    const o=$('bancoOrigen').value,d=$('bancoDestino').value,m=parseFloat($('montoTransferencia').value)||0,t=parseFloat($('transfTasa').value)||0;
    if(!m||!t){pv.style.display='none';return}
    const oi=getBancoInfo(o),di=getBancoInfo(d);
    let recibe;
    if(oi.moneda==='UYU'&&di.moneda==='USD')recibe='US$'+fmtNum(m/t,2);
    else recibe='$'+fmtNum(m*t,2);
    pv.style.display='block';
    pv.innerHTML=`ğŸ’± Debita <b>${getSym(oi.moneda)}${fmtNum(m)}</b> de ${colorBanco(o)} â†’ Recibe <b>${recibe}</b> en ${colorBanco(d)}<div style="margin-top:4px;font-size:0.8em;color:#64748b">Solo mueve saldos Â· No afecta ganancia</div>`;
}

function abrirModalTransferencia(){
    $('montoTransferencia').value='';$('comisionTransferencia').value='0';$('transfTasa').value='';$('transfConvPreview').style.display='none';
    const opts='<option value="">Seleccionar</option>'+getBancosActivos().map(b=>`<option value="${b.nombre}" style="color:${b.color||'#1e293b'};font-weight:600">${b.nombre} (${b.moneda})</option>`).join('');
    $('bancoOrigen').innerHTML=opts;$('bancoDestino').innerHTML=opts;$('saldoOrigenInfo').textContent='';$('btnTransferir').disabled=false;
    actualizarTransfUI();abrirModal('modalTransferencia');
}

async function realizarTransferencia(){
    if(AppState.ui.enCooldown||AppState.ui.guardandoTransferencia)return;const btn=$('btnTransferir');if(btn.disabled)return;
    const o=$('bancoOrigen').value,d=$('bancoDestino').value,m=parseFloat($('montoTransferencia').value),c=roundMoney(parseFloat($('comisionTransferencia').value)||0),f=getUDateStr();
    if(!o||!d||o===d)return alert('SeleccionÃ¡ bancos diferentes');if(!m||m<=0)return alert('Monto invÃ¡lido');
    const cross=esCrossMoneda();
    if(cross){
        const t=parseFloat($('transfTasa').value);
        if(!t||t<=0)return alert('IngresÃ¡ una tasa de conversiÃ³n vÃ¡lida');
        const oi=getBancoInfo(o),di=getBancoInfo(d);
        let montoRecibido;
        if(oi.moneda==='UYU'&&di.moneda==='USD')montoRecibido=roundMoney(m/t);
        else montoRecibido=roundMoney(m*t);
        btn.disabled=true;btn.textContent='Convirtiendo...';AppState.ui.guardandoTransferencia=true;
        try{
            AppState.datos.conversiones.unshift({id:Date.now(),origen:o,destino:d,montoOrigen:m,montoDestino:montoRecibido,tasa:t,monedaOrigen:oi.moneda,monedaDestino:di.moneda,fecha:f,hora:getUTimeStr(),timestamp:new Date().toISOString()});
            AppState.datos.bancos[o].saldo=fixNeg(AppState.datos.bancos[o].saldo-m);
            AppState.datos.bancos[d].saldo=fixNeg(AppState.datos.bancos[d].saldo+montoRecibido);
            await guardarDatos();actualizarVista();cerrarModal('modalTransferencia');activarCooldown();
        }finally{AppState.ui.guardandoTransferencia=false;btn.disabled=false;btn.textContent='Convertir'}
    }else{
        if(AppState.datos.bancos[o].limiteDiarioUSD>0){const bi=getBancoInfo(o);let mU=0;if(bi?.moneda==='USD')mU=m+c;else if(AppState.datos.ultimaTasaCompra>0)mU=roundMoney((m+c)/AppState.datos.ultimaTasaCompra);const dU=roundMoney(AppState.datos.bancos[o].limiteDiarioUSD-(AppState.datos.bancos[o].limiteUsadoUSD||0));if(mU>dU){alert(`Excede el lÃ­mite diario de ${o}. Disponible: US$${fmtNum(dU,0)} (necesitÃ¡s US$${fmtNum(mU,0)})`);return}}
        btn.disabled=true;btn.textContent='Transfiriendo...';AppState.ui.guardandoTransferencia=true;
        try{
            AppState.datos.transferencias.unshift({id:Date.now(),origen:o,destino:d,monto:m,comision:c,fecha:f,hora:getUTimeStr(),timestamp:new Date().toISOString()});
            AppState.datos.bancos[o].saldo=fixNeg(AppState.datos.bancos[o].saldo-(m+c));AppState.datos.bancos[d].saldo=fixNeg(AppState.datos.bancos[d].saldo+m);
            if(AppState.datos.bancos[o].limiteDiarioUSD>0){const bi=getBancoInfo(o);let mU=0;if(bi?.moneda==='USD')mU=m+c;else if(AppState.datos.ultimaTasaCompra>0)mU=roundMoney((m+c)/AppState.datos.ultimaTasaCompra);if(mU>0)AppState.datos.bancos[o].limiteUsadoUSD=Math.min(AppState.datos.bancos[o].limiteDiarioUSD,roundMoney((AppState.datos.bancos[o].limiteUsadoUSD||0)+mU))}
            await guardarDatos();actualizarVista();cerrarModal('modalTransferencia');activarCooldown();
        }finally{AppState.ui.guardandoTransferencia=false;btn.disabled=false;btn.textContent='Transferir'}
    }
}

async function eliminarTransferencia(id){
    if(!confirm('Â¿Eliminar?'))return;const t=AppState.datos.transferencias.find(x=>x.id===id);
    if(t){AppState.datos.bancos[t.origen].saldo=fixNeg(AppState.datos.bancos[t.origen].saldo+(t.monto+t.comision));AppState.datos.bancos[t.destino].saldo=fixNeg(AppState.datos.bancos[t.destino].saldo-t.monto);
        if(AppState.datos.bancos[t.origen].limiteDiarioUSD>0){const bi=getBancoInfo(t.origen);let mU=0;if(bi?.moneda==='USD')mU=t.monto+t.comision;else if(AppState.datos.ultimaTasaCompra>0)mU=roundMoney((t.monto+t.comision)/AppState.datos.ultimaTasaCompra);if(mU>0)AppState.datos.bancos[t.origen].limiteUsadoUSD=Math.max(0,roundMoney((AppState.datos.bancos[t.origen].limiteUsadoUSD||0)-mU))}}
    AppState.datos.transferencias=AppState.datos.transferencias.filter(x=>x.id!==id);await guardarDatos();actualizarVista();
}

async function eliminarConversion(id){
    if(!confirm('Â¿Eliminar conversiÃ³n?'))return;
    const c=AppState.datos.conversiones.find(x=>x.id===id);
    if(c){AppState.datos.bancos[c.origen].saldo=fixNeg(AppState.datos.bancos[c.origen].saldo+c.montoOrigen);AppState.datos.bancos[c.destino].saldo=fixNeg(AppState.datos.bancos[c.destino].saldo-c.montoDestino)}
    AppState.datos.conversiones=AppState.datos.conversiones.filter(x=>x.id!==id);await guardarDatos();actualizarVista();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Â§12 â€” CALENDARIO
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function calcularGananciaDiaria(monedaFiltro){
    const g={};AppState.datos.operaciones.forEach(op=>{
        if(monedaFiltro&&op.moneda!==monedaFiltro)return;
        if(!monedaFiltro&&op.moneda==='USD')return;
        if(!g[op.fecha])g[op.fecha]=0;if(op.ganancia!==undefined)g[op.fecha]=roundMoney(g[op.fecha]+op.ganancia)});
    if(!monedaFiltro||monedaFiltro==='UYU'){
        AppState.datos.movimientos.forEach(mv=>{if(mv.tipoMovimiento==='egreso'){if(!g[mv.fecha])g[mv.fecha]=0;if(mv.tipoCuenta==='usdt'){g[mv.fecha]=roundMoney(g[mv.fecha]-(mv.valorUYU||roundMoney(mv.monto*(AppState.datos.ultimaTasaCompra||1))))}else g[mv.fecha]=roundMoney(g[mv.fecha]-mv.monto)}});
    }
    return g;
}
function calcularGananciaTotal(monedaFiltro){
    let g=0;AppState.datos.operaciones.forEach(op=>{
        if(monedaFiltro&&op.moneda!==monedaFiltro)return;
        if(!monedaFiltro&&op.moneda==='USD')return;
        if(op.ganancia!==undefined)g=roundMoney(g+op.ganancia)});
    if(!monedaFiltro||monedaFiltro==='UYU'){
        AppState.datos.movimientos.forEach(mv=>{if(mv.tipoMovimiento==='egreso'){if(mv.tipoCuenta==='usdt')g=roundMoney(g-(mv.valorUYU||roundMoney(mv.monto*(AppState.datos.ultimaTasaCompra||1))));else g=roundMoney(g-mv.monto)}});
    }
    return g;
}

function renderizarCalendario(){
    const y=AppState.ui.calendarDate.getFullYear(),mo=AppState.ui.calendarDate.getMonth();
    setText('calendarMonth',`${y}-${String(mo+1).padStart(2,'0')}`);
    const fd=new Date(y,mo,1).getDay(),dm=new Date(y,mo+1,0).getDate(),hoy=new Date(),g=calcularGananciaDiaria();
    let h='',tg=0,tp=0;
    for(let i=0;i<fd;i++)h+='<div class="calendar-day empty"></div>';
    for(let d=1;d<=dm;d++){const ds=`${y}-${String(mo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`,val=g[ds]||0,isH=hoy.getFullYear()===y&&hoy.getMonth()===mo&&hoy.getDate()===d;
        let cls='calendar-day';if(val>0){cls+=' positive';tg+=val}else if(val<0){cls+=' negative';tp+=Math.abs(val)}if(isH)cls+=' today';
        const vs=val!==0?(val>0?'+':'')+fmtNum(val,0):'0',vc=val>0?'pos':val<0?'neg':'';
        h+=`<div class="${cls}"><div class="calendar-day-number">${d}</div><div class="calendar-day-value ${vc}">${vs}</div></div>`}
    setHtml('calendarDays',h);
    const gt=calcularGananciaTotal(),ge=$('calGananciaTotal');ge.textContent=(gt>=0?'+':'-')+'$'+fmtNum(Math.abs(gt),0);ge.className='calendar-stat-value '+(gt>=0?'positive':'negative');
    setText('calGanancias','+$'+fmtNum(tg,0));setText('calPerdidas','-$'+fmtNum(tp,0));
    // USD total
    const calUSDBox=$('calGananciaUSDBox'),calUSD=$('calGananciaUSD');
    if(calUSD&&calUSDBox){if(hayBancosUSD()){const gtU=calcularGananciaTotal('USD');calUSDBox.style.display='';calUSD.textContent=(gtU>=0?'+':'-')+'US$'+fmtNum(Math.abs(gtU),0);calUSD.className='calendar-stat-value '+(gtU>=0?'positive':'negative')}else calUSDBox.style.display='none'}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Â§13 â€” PAGINACIONES (instancias)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const pagOp=crearPaginacion({getTotal:()=>AppState.datos.operaciones.length,getPag:()=>AppState.ui.paginaOp,setPag:p=>{AppState.ui.paginaOp=p},porPag:CONFIG.POR_PAGINA,
    ids:{pagination:'paginationOp',info:'paginaInfoOp',prev:'btnPrevOp',next:'btnNextOp'},
    renderFn:(ini,fin,total)=>{
        setText('totalOperaciones',total||0);const c=$('tablaContent');
        if(!total){c.innerHTML='<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><div>Sin operaciones</div></div>';return}
        const ops=AppState.datos.operaciones.slice(ini,fin);let h='<table><thead><tr><th>Tipo</th><th>Monto</th><th>Tasa</th><th>USDT</th><th>Banco</th><th>G/P</th><th>Fecha</th><th></th></tr></thead><tbody>';
        ops.forEach(op=>{const un=op.tipo==='compra'?truncUsdt(op.usdt-op.comisionPlataforma):truncUsdt(op.usdt+op.comisionPlataforma);const badge=op.tipo==='compra'?'<span class="badge badge-compra"><b>Compra</b></span>':'<span class="badge badge-venta"><b>Venta</b></span>';const gn=op.ganancia||0,gc=gn>=0?'#16a34a':'#dc2626',gt=gn>=0?'+$'+fmtNum(gn):'-$'+fmtNum(Math.abs(gn)),sy=op.moneda==='USD'?'US$':'$',td=op.moneda==='USD'?3:2;
            h+=`<tr><td>${badge}</td><td><b>${sy}${fmtNum(op.monto)}</b></td><td>${sy}${fmtNum(op.tasa,td)}</td><td><b>${fmtTrunc(un,2)}</b></td><td style="color:${getBancoColor(op.banco)};font-weight:600;font-size:0.75em">${op.banco||'-'}</td><td style="color:${gc};font-weight:600">${gt}</td><td>${fechaHtml(op.fecha,op.hora)}</td><td><button class="btn-delete" data-action="eliminar-op" data-id="${op.id}">Ã—</button></td></tr>`});
        c.innerHTML=h+'</tbody></table>';
    }
});

const pagMov=crearPaginacion({getTotal:()=>AppState.datos.movimientos.length,getPag:()=>AppState.ui.paginaMov,setPag:p=>{AppState.ui.paginaMov=p},porPag:CONFIG.POR_PAGINA,
    ids:{pagination:'paginationMov',info:'paginaInfoMov',prev:'btnPrevMov',next:'btnNextMov'},
    renderFn:(ini,fin,total)=>{
        setText('totalMovimientos',total||0);const sec=$('seccionMovimientos');if(!total){sec.style.display='none';return}sec.style.display='block';
        const mvs=AppState.datos.movimientos.slice(ini,fin);let h='<table><thead><tr><th>Tipo</th><th>Cuenta</th><th>Monto</th><th>Desc</th><th>Fecha</th><th></th></tr></thead><tbody>';
        mvs.forEach(m=>{const badge=m.tipoMovimiento==='ingreso'?'<span class="badge badge-ingreso"><b>Ingreso</b></span>':'<span class="badge badge-egreso"><b>Egreso</b></span>';
            h+=`<tr><td>${badge}</td><td>${m.tipoCuenta==='usdt'?'ğŸª™ USDT':colorBanco(m.banco)}</td><td><b>${m.tipoCuenta==='usdt'?'':'$'}${fmtNum(m.monto)}${m.tipoCuenta==='usdt'?' USDT':''}</b></td><td style="color:#64748b;max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${m.descripcion||'-'}</td><td>${fechaHtml(m.fecha,m.hora)}</td><td><button class="btn-delete" data-action="eliminar-mov" data-id="${m.id}">Ã—</button></td></tr>`});
        $('movimientosContent').innerHTML=h+'</tbody></table>';
    }
});

const pagTrans=crearPaginacion({getTotal:()=>AppState.datos.transferencias.length,getPag:()=>AppState.ui.paginaTrans,setPag:p=>{AppState.ui.paginaTrans=p},porPag:CONFIG.POR_PAGINA,
    ids:{pagination:'paginationTrans',info:'paginaInfoTrans',prev:'btnPrevTrans',next:'btnNextTrans'},
    renderFn:(ini,fin,total)=>{
        setText('totalTransferencias',total||0);const sec=$('seccionTransferencias');if(!total){sec.style.display='none';return}sec.style.display='block';
        const trs=AppState.datos.transferencias.slice(ini,fin);let h='<table><thead><tr><th>Origen</th><th>Destino</th><th>Monto</th><th>Com</th><th>Fecha</th><th></th></tr></thead><tbody>';
        trs.forEach(tr=>{const oi=getBancoInfo(tr.origen),sy=getSym(oi?.moneda);
            h+=`<tr><td>${colorBanco(tr.origen)}</td><td>${colorBanco(tr.destino)}</td><td><b>${sy}${fmtNum(tr.monto)}</b></td><td style="color:#ea580c">${tr.comision>0?sy+fmtNum(tr.comision):'-'}</td><td>${fechaHtml(tr.fecha,tr.hora)}</td><td><button class="btn-delete" data-action="eliminar-trans" data-id="${tr.id}">Ã—</button></td></tr>`});
        $('transferenciasContent').innerHTML=h+'</tbody></table>';
    }
});

const pagConv=crearPaginacion({getTotal:()=>(AppState.datos.conversiones||[]).length,getPag:()=>AppState.ui.paginaConv||1,setPag:p=>{AppState.ui.paginaConv=p},porPag:CONFIG.POR_PAGINA,
    ids:{pagination:'paginationConv',info:'paginaInfoConv',prev:'btnPrevConv',next:'btnNextConv'},
    renderFn:(ini,fin,total)=>{
        setText('totalConversiones',total||0);const sec=$('seccionConversiones');if(!total){sec.style.display='none';return}sec.style.display='block';
        const cvs=(AppState.datos.conversiones||[]).slice(ini,fin);let h='<table><thead><tr><th>Origen</th><th>Destino</th><th>Debita</th><th>Recibe</th><th>Tasa</th><th>Fecha</th><th></th></tr></thead><tbody>';
        cvs.forEach(c=>{const syO=c.monedaOrigen==='USD'?'US$':'$',syD=c.monedaDestino==='USD'?'US$':'$';
            h+=`<tr><td>${colorBanco(c.origen)}</td><td>${colorBanco(c.destino)}</td><td><b>${syO}${fmtNum(c.montoOrigen)}</b></td><td><b>${syD}${fmtNum(c.montoDestino)}</b></td><td>${fmtNum(c.tasa)}</td><td>${fechaHtml(c.fecha,c.hora)}</td><td><button class="btn-delete" data-action="eliminar-conv" data-id="${c.id}">Ã—</button></td></tr>`});
        $('conversionesContent').innerHTML=h+'</tbody></table>';
    }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Â§14 â€” DASHBOARD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function actualizarVista(){
    const hoy=getUDate(),mesA=`${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2,'0')}`,ops=AppState.datos.operaciones.filter(op=>op.fecha&&op.fecha.startsWith(mesA));
    let tp=0,tr=0,stc=0,stv=0,cc=0,cv=0;
    ops.forEach(op=>{if(op.tipo==='compra'){tp=roundMoney(tp+op.monto+(op.comisionBanco||0));stc=roundMoney(stc+op.tasa);cc++}else{tr=roundMoney(tr+op.monto);stv=roundMoney(stv+op.tasa);cv++}});
    const tpc=cc?roundMoney(stc/cc):0,tpv=cv?roundMoney(stv/cv):0,sp=roundMoney(tpv-tpc);
    let tb=0;CONFIG.BANCOS.forEach(b=>{if(AppState.datos.bancos[b.nombre]?.activo&&b.moneda==='UYU')tb+=AppState.datos.bancos[b.nombre].saldo});
    const hoyStr=getUDateStr(),opsH=AppState.datos.operaciones.filter(o=>o.fecha===hoyStr).length;
    const gH=calcularGananciaDiaria()[hoyStr]||0,ghE=$('gananciaHoy'),cH=$('cardGananciaHoy');
    if(gH>=0){ghE.textContent='+$'+fmtNum(gH);ghE.className='card-value positive';cH.className='card main-card'}
    else{ghE.textContent='-$'+fmtNum(Math.abs(gH));ghE.className='card-value negative';cH.className='card main-card negative'}
    const ds=['Domingo','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado'];
    setText('fechaHoy',ds[hoy.getDay()]+' '+hoy.getDate()+'/'+(hoy.getMonth()+1));setText('opsHoy',opsH+' ops hoy');
    // â€” Ganancia Hoy USD â€”
    const tieneUSD=hayBancosUSD(),cardUSD=$('cardGananciaUSD');
    if(tieneUSD){
        cardUSD.style.display='block';
        const opsUSDHoy=AppState.datos.operaciones.filter(o=>o.fecha===hoyStr&&o.moneda==='USD');
        let gUSD=0;opsUSDHoy.forEach(o=>{if(o.ganancia!==undefined)gUSD=roundMoney(gUSD+o.ganancia)});
        const nUSD=opsUSDHoy.length,geU=$('gananciaHoyUSD');
        if(gUSD>=0){geU.textContent='+US$'+fmtNum(gUSD);geU.className='card-value positive'}
        else{geU.textContent='-US$'+fmtNum(Math.abs(gUSD));geU.className='card-value negative'}
        setText('opsHoyUSD',nUSD+' ops USD hoy');
    }else cardUSD.style.display='none';
    setText('usdtEnTenencia',fmtTrunc(Math.max(0,AppState.datos.saldoUsdt),2));setText('totalBancos','$'+fmtNum(tb,0));
    setText('totalPagado','$'+fmtNum(tp,0));setText('tasaPromCompra','Prom: $'+fmtNum(tpc));
    const meses=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],mn=parseInt(mesA.split('-')[1])-1;
    setText('mesCompras','('+meses[mn]+')');setText('mesVentas','('+meses[mn]+')');
    const la=AppState.datos.lotes.filter(l=>l.disponible>0);
    if(la.length>0){const lm=la.reduce((m,l)=>l.precioCompra<m.precioCompra?l:m,la[0]);setText('loteMasBarato','Min: $'+fmtNum(lm.precioCompra));setText('lotesDisponibles',la.length+' lotes')}
    else{setText('loteMasBarato','Sin stock');setText('lotesDisponibles','0 lotes')}
    setText('totalRecibido','$'+fmtNum(tr,0));setText('tasaPromVenta','Prom: $'+fmtNum(tpv));
    setText('spreadPromedio','$'+fmtNum(sp));setText('porcentajeSpread',fmtNum(tpc?(sp/tpc)*100:0,1)+'%');
    actualizarBancosGrid();actualizarSelectBancos();pagOp.render();pagMov.render();pagTrans.render();pagConv.render();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Â§15 â€” LOTES MODAL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function abrirEditarLote(id){
    AppState.ui.loteEditandoId=id;const l=id?AppState.datos.lotes.find(x=>x.id===id):null;
    if(l){setText('editarLoteHeader','âœï¸ Editar Lote');$('lotePrecio').value=l.precioCompra;$('loteDisponible').value=l.disponible;$('loteFecha').value=l.fecha||'';$('btnEliminarLote').style.display='inline-block'}
    else{setText('editarLoteHeader','â• Agregar Lote');$('lotePrecio').value=AppState.datos.ultimaTasaCompra||'';$('loteDisponible').value='';$('loteFecha').value=getUDateStr();$('btnEliminarLote').style.display='none'}
    abrirModal('modalEditarLote');
}
async function guardarLote(){
    if(AppState.ui.guardandoLote)return;
    const btn=$('btnGuardarLote');if(btn.disabled)return;
    const p=parseFloat($('lotePrecio').value),d=parseFloat($('loteDisponible').value),f=$('loteFecha').value||getUDateStr();
    if(!p||p<=0){alert('IngresÃ¡ un precio vÃ¡lido');return}if(d===undefined||d<0||isNaN(d)){alert('IngresÃ¡ una cantidad vÃ¡lida');return}
    AppState.ui.guardandoLote=true;btn.disabled=true;btn.textContent='Guardando...';
    try{
        if(AppState.ui.loteEditandoId){const l=AppState.datos.lotes.find(x=>x.id===AppState.ui.loteEditandoId);if(l){l.precioCompra=roundMoney(p,3);l.disponible=truncUsdt(d);l.cantidad=Math.max(l.cantidad,truncUsdt(d));l.fecha=f}}
        else AppState.datos.lotes.push({id:Date.now(),fecha:f,hora:getUTimeStr(),precioCompra:roundMoney(p,3),cantidad:truncUsdt(d),disponible:truncUsdt(d),moneda:'UYU'});
        sincronizarSaldoUsdt();await guardarDatos();actualizarVista();renderizarInventario();cerrarModal('modalEditarLote');AppState.ui.loteEditandoId=null;
    }finally{AppState.ui.guardandoLote=false;btn.disabled=false;btn.textContent='Guardar'}
}
async function eliminarLoteActual(){if(!AppState.ui.loteEditandoId||AppState.ui.guardandoLote)return;if(!confirm('Â¿Eliminar este lote del inventario?'))return;AppState.ui.guardandoLote=true;const btn=$('btnEliminarLote');btn.disabled=true;btn.textContent='Eliminando...';try{AppState.datos.lotes=AppState.datos.lotes.filter(l=>l.id!==AppState.ui.loteEditandoId);sincronizarSaldoUsdt();await guardarDatos();actualizarVista();renderizarInventario();cerrarModal('modalEditarLote');AppState.ui.loteEditandoId=null}finally{AppState.ui.guardandoLote=false;btn.disabled=false;btn.textContent='Eliminar'}}
async function forzarRecalculo(){if(!confirm('Â¿Recalcular todos los lotes y ganancias desde las operaciones y movimientos?'))return;recalcularLotesYGanancias();await guardarDatos();actualizarVista();renderizarInventario();alert('âœ… Lotes, saldo USDT y ganancias recalculados')}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Â§16 â€” BORRAR TODO
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function borrarTodo(){
    if(confirm('âš ï¸ Â¿Borrar TODO?')&&confirm('No se puede deshacer. Â¿Continuar?')){
        AppState.datos=crearDatosVacios();inicializarBancos();AppState.ui.paginaOp=1;AppState.ui.paginaMov=1;AppState.ui.paginaTrans=1;AppState.ui.paginaConv=1;
        $('comisionPlataforma').value='0.14';setText('comisionPctLabel','0.14');
        await guardarDatos();actualizarVista();
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Â§17 â€” EVENT LISTENERS (sin inline)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded',()=>{
    // Auth
    $('tabLogin').addEventListener('click',()=>{$('tabLogin').classList.add('active');$('tabRegister').classList.remove('active');$('loginForm').style.display='block';$('registerForm').style.display='none';$('authError').classList.remove('show')});
    $('tabRegister').addEventListener('click',()=>{$('tabRegister').classList.add('active');$('tabLogin').classList.remove('active');$('registerForm').style.display='block';$('loginForm').style.display='none';$('authError').classList.remove('show')});
    $('loginForm').addEventListener('submit',async e=>{e.preventDefault();$('authError').classList.remove('show');const u=$('loginUser').value.trim(),p=$('loginPass').value,b=$('loginBtn');b.disabled=true;b.textContent='Entrando...';try{await AppState.auth.signInWithEmailAndPassword(userToEmail(u),p)}catch(er){$('authError').textContent='Usuario o contraseÃ±a incorrectos';$('authError').classList.add('show');b.disabled=false;b.textContent='Iniciar SesiÃ³n'}});
    $('registerForm').addEventListener('submit',async e=>{e.preventDefault();$('authError').classList.remove('show');const u=$('regUser').value.trim(),p=$('regPass').value,p2=$('regPassConfirm').value,ae=$('authError');
        if(!/^[a-zA-Z0-9_-]{3,20}$/.test(u)){ae.textContent='Usuario invÃ¡lido';ae.classList.add('show');return}if(p.length<6){ae.textContent='MÃ­nimo 6 caracteres';ae.classList.add('show');return}if(p!==p2){ae.textContent='No coinciden';ae.classList.add('show');return}
        const b=$('registerBtn');b.disabled=true;b.textContent='Creando...';try{await AppState.auth.createUserWithEmailAndPassword(userToEmail(u),p)}catch(er){ae.textContent=er.code==='auth/email-already-in-use'?'Usuario ya existe':'Error';ae.classList.add('show');b.disabled=false;b.textContent='Crear Cuenta'}});

    // Menu
    $('menuBtn').addEventListener('click',e=>{e.stopPropagation();$('menuBtn').classList.toggle('active');$('menuDropdown').classList.toggle('active')});
    document.addEventListener('click',e=>{const m=document.querySelector('.menu-container');if(m&&!m.contains(e.target)){$('menuBtn').classList.remove('active');$('menuDropdown').classList.remove('active')}});
    $('menuDropdown').addEventListener('click',e=>{const item=e.target.closest('[data-action]');if(!item)return;$('menuBtn').classList.remove('active');$('menuDropdown').classList.remove('active');
        const a=item.dataset.action;
        if(a==='calendario'){AppState.ui.calendarDate=new Date();renderizarCalendario();abrirModal('modalCalendario')}
        else if(a==='inventario'){renderizarInventario();abrirModal('modalInventario')}
        else if(a==='movimiento')abrirModalMovimiento();
        else if(a==='bancos'){renderizarListaBancos();abrirModal('modalBancos')}
        else if(a==='transferencia')abrirModalTransferencia();
        else if(a==='gestion-tags'){renderizarGestionTags();abrirModal('modalGestionTags')}
        else if(a==='borrar-todo')borrarTodo();
        else if(a==='cerrar-sesion'){if(confirm('Â¿Cerrar sesiÃ³n?')){if(AppState.unsubscribe)AppState.unsubscribe();AppState.auth.signOut()}}
    });

    // Toggle sections
    document.querySelectorAll('.toggle-header').forEach(h=>h.addEventListener('click',()=>h.closest('.toggle-section')?.classList.toggle('open')));

    // Formulario
    $('tipo').addEventListener('change',()=>{AppState.ui.tasaManual=false;AppState.ui.ultimoMonedaBanco=null;actualizarFormulario();actualizarColorSelect()});
    $('monto').addEventListener('input',calcularPreview);
    $('tasa').addEventListener('input',()=>{AppState.ui.tasaManual=true;calcularPreview()});
    $('banco').addEventListener('change',()=>{mostrarSaldoBanco();actualizarFormulario();actualizarColorBancoSelect()});
    $('comisionPlataforma').addEventListener('input',guardarComisionYCalcular);
    $('btnAgregarOp').addEventListener('click',agregarOperacion);

    // PaginaciÃ³n
    $('btnPrevOp').addEventListener('click',()=>pagOp.cambiar(-1));
    $('btnNextOp').addEventListener('click',()=>pagOp.cambiar(1));
    $('btnPrevMov').addEventListener('click',()=>pagMov.cambiar(-1));
    $('btnNextMov').addEventListener('click',()=>pagMov.cambiar(1));
    $('btnPrevTrans').addEventListener('click',()=>pagTrans.cambiar(-1));
    $('btnNextTrans').addEventListener('click',()=>pagTrans.cambiar(1));
    $('btnPrevConv').addEventListener('click',()=>pagConv.cambiar(-1));
    $('btnNextConv').addEventListener('click',()=>pagConv.cambiar(1));

    // Modales con botones fijos
    $('tabIngreso').addEventListener('click',()=>setTipoMovimiento('ingreso'));
    $('tabEgreso').addEventListener('click',()=>setTipoMovimiento('egreso'));
    $('movTipoCuenta').addEventListener('change',actualizarCuentasMovimiento);
    $('movBanco').addEventListener('change',()=>{const v=$('movBanco').value;$('movBanco').style.color=v?getBancoColor(v):'#1e293b';$('movBanco').style.fontWeight=v?'600':'400'});
    $('btnGuardarMov').addEventListener('click',guardarMovimiento);
    $('btnCancelMov').addEventListener('click',()=>cerrarModal('modalMovimiento'));
    $('btnCerrarBancos').addEventListener('click',()=>{cerrarModal('modalBancos');guardarDatos();actualizarVista()});
    $('bancoOrigen').addEventListener('change',()=>{const v=$('bancoOrigen').value;$('bancoOrigen').style.color=v?getBancoColor(v):'#1e293b';mostrarSaldoOrigen();actualizarTransfUI()});
    $('bancoDestino').addEventListener('change',()=>{const v=$('bancoDestino').value;$('bancoDestino').style.color=v?getBancoColor(v):'#1e293b';actualizarTransfUI()});
    $('montoTransferencia').addEventListener('input',actualizarTransfPreview);
    $('transfTasa').addEventListener('input',actualizarTransfPreview);
    $('btnTransferir').addEventListener('click',realizarTransferencia);
    $('btnCancelTransf').addEventListener('click',()=>cerrarModal('modalTransferencia'));
    $('movMonto').addEventListener('input',actualizarFifoPreview);
    $('btnCancelSaldo').addEventListener('click',()=>{cerrarModal('modalEditarSaldo');AppState.ui.bancoEditando=null});
    $('btnGuardarSaldo').addEventListener('click',async()=>{const ns=roundMoney(parseFloat($('nuevoSaldoBanco').value)||0),n=AppState.ui.bancoEditando;if(n&&AppState.datos.bancos[n]){AppState.datos.bancos[n].saldo=fixNeg(ns);AppState.datos.bancos[n].limiteDiarioUSD=roundMoney(parseFloat($('limiteDiarioBanco').value)||0)}await guardarDatos();actualizarVista();renderizarListaBancos();cerrarModal('modalEditarSaldo');AppState.ui.bancoEditando=null});
    $('btnAgregarLote').addEventListener('click',()=>abrirEditarLote(null));
    $('btnRecalcular').addEventListener('click',()=>forzarRecalculo().then(()=>actualizarVista()));
    $('btnCerrarInventario').addEventListener('click',()=>cerrarModal('modalInventario'));
    $('btnCancelLote').addEventListener('click',()=>{cerrarModal('modalEditarLote');AppState.ui.loteEditandoId=null});
    $('btnEliminarLote').addEventListener('click',eliminarLoteActual);
    $('btnGuardarLote').addEventListener('click',guardarLote);
    $('btnCerrarTags').addEventListener('click',()=>cerrarModal('modalGestionTags'));
    $('tagSearch').addEventListener('input',renderizarGestionTags);
    $('movDescripcion').addEventListener('input',()=>renderizarTagsSugerencias('movDescripcion','tagSugerenciasMov'));
    $('btnCalPrev').addEventListener('click',()=>{AppState.ui.calendarDate.setMonth(AppState.ui.calendarDate.getMonth()-1);renderizarCalendario()});
    $('btnCalNext').addEventListener('click',()=>{AppState.ui.calendarDate.setMonth(AppState.ui.calendarDate.getMonth()+1);renderizarCalendario()});
    $('btnCerrarCalendario').addEventListener('click',()=>cerrarModal('modalCalendario'));

    // DelegaciÃ³n de eventos para contenido dinÃ¡mico
    document.addEventListener('click',e=>{
        const t=e.target.closest('[data-action]');if(!t)return;
        const a=t.dataset.action,id=parseInt(t.dataset.id),banco=t.dataset.banco,loteId=parseInt(t.dataset.loteId);
        if(a==='eliminar-op')eliminarOperacion(id);
        else if(a==='eliminar-mov')eliminarMovimiento(id);
        else if(a==='eliminar-trans')eliminarTransferencia(id);
        else if(a==='eliminar-conv')eliminarConversion(id);
        else if(a==='editar-saldo'){if(banco==='USDT'){renderizarInventario();abrirModal('modalInventario')}else{AppState.ui.bancoEditando=banco;$('editarSaldoHeader').innerHTML='Editar '+colorBanco(banco);$('nuevoSaldoBanco').value=AppState.datos.bancos[banco]?.saldo||0;$('limiteDiarioGroup').style.display='block';$('limiteDiarioBanco').value=AppState.datos.bancos[banco]?.limiteDiarioUSD||0;abrirModal('modalEditarSaldo')}}
        else if(a==='toggle-banco'){const n=t.dataset.banco;if(!AppState.datos.bancos[n])AppState.datos.bancos[n]={activo:false,saldo:0,limiteDiarioUSD:0,limiteUsadoUSD:0};AppState.datos.bancos[n].activo=!AppState.datos.bancos[n].activo;guardarDatos();renderizarListaBancos()}
        else if(a==='inventario'){renderizarInventario();abrirModal('modalInventario')}
        else if(a==='editar-lote')abrirEditarLote(loteId);
        else if(a==='usar-tag'){
            const tag=t.dataset.tag,target=t.dataset.target;
            if(tag&&target){const inp=$(target);if(inp){inp.value=tag;inp.focus();renderizarTagsSugerencias(target,target==='movDescripcion'?'tagSugerenciasMov':'')}}
        }
        else if(a==='editar-tag'){
            const oldTag=t.dataset.tag;if(!oldTag)return;
            const nuevoNombre=prompt('Editar etiqueta:',oldTag);
            if(nuevoNombre!==null){if(editarTag(oldTag,nuevoNombre)){guardarDatos();renderizarGestionTags()}else{alert('Nombre invÃ¡lido o ya existe')}}
        }
        else if(a==='eliminar-tag'){
            const tag=t.dataset.tag;if(!tag)return;
            if(confirm(`Â¿Eliminar la etiqueta "${tag}"?`)){eliminarTag(tag);guardarDatos();renderizarGestionTags()}
        }
    });

    // Escape cierra modales
    document.addEventListener('keydown',e=>{if(e.key==='Escape'){document.querySelectorAll('.modal.active').forEach(m=>m.classList.remove('active'));$('menuBtn')?.classList.remove('active');$('menuDropdown')?.classList.remove('active')}});

    // Init
    actualizarFormulario();actualizarColorSelect();inicializarFirebase();
    setInterval(()=>{verificarResetLimites();actualizarVista()},60000);
});
    </script>
</body>
</html>
